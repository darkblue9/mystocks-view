<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 v3.2 (고정가/현재가 · 엔드포인트 자동감지)</title>
<style>
  :root{ --border:#e5e7eb; --muted:#6b7280; --ok:#059669; --bad:#ef4444; --accent:#2563eb; }
  html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 12px}
  .box{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px 12px}
  .mini{font-size:12px;color:var(--muted)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
  .pill{border:1px solid var(--border);border-radius:8px;padding:4px 8px}
  input[type="text"],input[type="number"],select{width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:14px;background:#fff}
  input[readonly]{background:#f9fafb}
  button{border:1px solid var(--border);border-radius:8px;padding:6px 10px;background:#fff;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);padding:8px 6px}
  tbody td{border-bottom:1px solid var(--border);padding:6px}
  td,th{text-align:center;vertical-align:middle}
  .num{text-align:right}
  .w-code{width:110px}.w-name{width:170px}.w-qty{width:70px}.w-amt{width:120px}.w-price{width:110px}
  .profit-pos{color:var(--ok);font-weight:700}
  .profit-neg{color:var(--bad);font-weight:700}
  .totals{display:flex;justify-content:flex-end;gap:8px;margin-top:10px;align-items:center}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .w200{width:200px}.w120{width:120px}.w100{width:100px}.w70{width:70px}
</style>
</head>
<body>
<div class="wrap">
  <div class="controls box">
    <div class="row">
      <label class="mini">프록시 주소
        <input id="apiBase" class="pill w200" type="text" placeholder="http://localhost:3000/api">
      </label>
      <label class="mini">엔드포인트
        <select id="apiMode" class="w120">
          <option value="auto">자동 감지</option>
          <option value="multi">멀티(/prices?codes=)</option>
          <option value="single">단건(/price?code=)</option>
        </select>
      </label>
      <label class="mini"><input type="checkbox" id="liveToggle" checked> 실시간 ON</label>
      <label class="mini">풀링(초): <input id="pollSec" type="number" min="2" step="1" value="10" class="w70"></label>
      <button id="addRowBtn" class="primary">+ 종목 추가</button>
      <button id="saveBtn">저장</button>
      <span id="status" class="mini">상태: 대기</span>
    </div>
    <div class="mini">* 입력하면 즉시 계산, Enter/포커스 아웃 시 포맷 적용. 데이터는 localStorage에 저장.</div>
  </div>

  <div class="box">
    <table id="grid">
      <thead>
        <tr>
          <th class="w-code">코드</th>
          <th class="w-name">이름</th>
          <th class="w-price">평단가</th>
          <th class="w-qty">주수</th>
          <th class="w-amt">투입금액</th>
          <th class="w-price">현재가</th>
          <th class="w-price">고정가</th>
          <th class="w-amt">손익(원)</th>
          <th class="w-price">손익(%)</th>
          <th style="width:70px">삭제</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="totals">
      <span class="mini">총 손익:</span>
      <span id="totalProfit" class="profit-neg">0</span>
    </div>
  </div>
</div>

<script>
// ===== 유틸 =====
const $ = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt = (n)=> (n??0).toLocaleString('ko-KR');
const toNum = (v)=>{
  if(v===''||v==null) return 0;
  if(typeof v==='number') return v;
  return Number(String(v).replace(/,/g,''))||0;
};
const calcProfit = (avg, cur, fix, qty)=>{
  const base = (fix && !isNaN(fix) && fix!==0) ? fix : cur;
  if(!avg || !qty || !base) return {won:0, pct:0};
  const won = (base-avg)*qty;
  const pct = ((base-avg)/avg)*100;
  return {won, pct};
};

// ===== 저장 키 =====
const KEY_V3='stock_dashboard_rows_v3';
const KEY_SETTINGS='stock_dashboard_settings_v1';

function loadSettings(){
  try { return JSON.parse(localStorage.getItem(KEY_SETTINGS)) || {}; } catch { return {}; }
}
function saveSettings(s){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(s)); }

function loadRows(){
  try{ const r = JSON.parse(localStorage.getItem(KEY_V3)) || []; return r; }catch{return []}
}
function saveRows(r){ localStorage.setItem(KEY_V3, JSON.stringify(r)); }

// ===== 상태 =====
let rows = loadRows();
let timer=null;
let settings = Object.assign({apiBase:'http://localhost:3000/api', apiMode:'auto'}, loadSettings());

// apply settings to UI
$('#apiBase').value = settings.apiBase||'';
$('#apiMode').value = settings.apiMode||'auto';

// ===== 렌더 =====
function render(){
  const tb = $('#tbody'); tb.innerHTML='';
  rows.forEach(r=>{ r.invest = Math.round((r.avg||0)*(r.qty||0)); });
  rows.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="w-code"><input class="cell code" value="${r.code||''}"></td>
      <td class="w-name"><input class="cell name" value="${r.name||''}"></td>
      <td class="w-price num"><input class="cell avg num" placeholder="0" value="${r.avg?fmt(r.avg):''}"></td>
      <td class="w-qty num"><input class="cell qty num" placeholder="0" value="${r.qty||''}"></td>
      <td class="w-amt num"><input class="cell invest num" readonly value="${r.invest?fmt(r.invest):'0'}"></td>
      <td class="w-price num"><input class="cell cur num" placeholder="(실시간)" ${($('#liveToggle').checked?'readonly':'')} value="${r.cur?fmt(r.cur):''}"></td>
      <td class="w-price num"><input class="cell fix num" placeholder="고정가" value="${r.fix?fmt(r.fix):''}"></td>
      <td class="w-amt num"><span class="profit-won">0</span></td>
      <td class="w-price num"><span class="profit-pct">0.00%</span></td>
      <td><button class="danger del">삭제</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector('.del').addEventListener('click',()=>{ rows.splice(idx,1); saveRows(rows); render(); });

    const onChange=()=>applyRowEdit(idx,tr,true);
    const onCommit=(e)=>{ if(e) e.preventDefault(); applyRowEdit(idx,tr,false); };
    $$('input.cell',tr).forEach(inp=>{
      inp.addEventListener('input', onChange);
      inp.addEventListener('blur', onCommit);
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); } });
    });
  });
  updateProfits();
}

function applyRowEdit(i, tr, live){
  const r = rows[i];
  const get = (sel)=> tr.querySelector(sel)?.value ?? '';
  r.code = get('.code').trim();
  r.name = get('.name').trim();
  r.avg = toNum(get('.avg'));
  r.qty = toNum(get('.qty'));
  r.cur = toNum(get('.cur'));
  r.fix = toNum(get('.fix'));
  r.invest = Math.round((r.avg||0)*(r.qty||0));
  tr.querySelector('.invest').value = fmt(r.invest||0);
  if(!live){
    tr.querySelector('.avg').value = r.avg?fmt(r.avg):'';
    tr.querySelector('.qty').value = r.qty?String(r.qty):'';
    tr.querySelector('.cur').value = r.cur?fmt(r.cur):'';
    tr.querySelector('.fix').value = r.fix?fmt(r.fix):'';
  }
  saveRows(rows);
  updateProfits();
}

function updateProfits(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r = rows[i];
    const {won,pct} = calcProfit(r.avg,r.cur,r.fix,r.qty);
    total += won;
    const w = tr.querySelector('.profit-won');
    w.textContent = fmt(Math.round(won));
    w.className = 'profit-won ' + (won>=0?'profit-pos':'profit-neg');
    tr.querySelector('.profit-pct').textContent = (isFinite(pct)?pct.toFixed(2):'0.00')+'%';
  });
  const t=$('#totalProfit');
  t.textContent = fmt(Math.round(total));
  t.className = (total>=0)?'profit-pos':'profit-neg';
}

// ===== 가격 조회(자동 감지) =====
async function fetchPricesAuto(codes){
  const modeSel = $('#apiMode').value;
  let mode = (modeSel==='auto') ? settings.apiMode||'auto' : modeSel;
  if(mode==='auto') mode='multi'; // 먼저 멀티 시도
  try{
    if(mode==='multi'){
      await fetchPricesMulti(codes);
    }else{
      await fetchPricesSingle(codes);
    }
    // 성공했으면 현재 모드 저장
    settings.apiMode = (modeSel==='auto') ? mode : modeSel;
    saveSettings(settings);
    $('#status').textContent = `상태: OK (${settings.apiMode})`;
  }catch(e){
    // 멀티 실패 시 단건 재시도
    if(mode==='multi'){
      try{
        await fetchPricesSingle(codes);
        settings.apiMode = 'single';
        saveSettings(settings);
        $('#status').textContent = '상태: OK (single로 폴백)';
      }catch(err){
        $('#status').textContent = '상태: 오류 - 가격 조회 실패';
        console.warn('가격 조회 실패(폴백 포함):', err);
      }
    }else{
      $('#status').textContent = '상태: 오류 - 가격 조회 실패';
      console.warn('가격 조회 실패:', e);
    }
  }
}

async function fetchPricesMulti(codes){
  const base = ($('#apiBase').value||'').trim();
  if(!base) throw new Error('apiBase empty');
  settings.apiBase = base; saveSettings(settings);
  const q = encodeURIComponent(codes.join(','));
  const url = `${base.replace(/\/$/,'')}/prices?codes=${q}`;
  const res = await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const j = await res.json();
  (j.data||[]).forEach(p=>{
    const idx = rows.findIndex(r=>r.code===p.code);
    if(idx>=0){ rows[idx].cur = Number(p.price)||rows[idx].cur||0; }
  });
  saveRows(rows);
  $$('#tbody tr').forEach((tr,i)=> tr.querySelector('.cur').value = rows[i].cur?fmt(rows[i].cur):'');
  updateProfits();
}

async function fetchPricesSingle(codes){
  const base = ($('#apiBase').value||'').trim();
  if(!base) throw new Error('apiBase empty');
  settings.apiBase = base; saveSettings(settings);
  // 병렬 요청
  const results = await Promise.allSettled(codes.map(async code=>{
    const url = `${base.replace(/\/$/,'')}/price?code=${encodeURIComponent(code)}`;
    const res = await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j = await res.json();
    return {code, price: Number(j.price ?? j.data?.price ?? 0)};
  }));
  results.forEach(r=>{
    if(r.status==='fulfilled'){
      const {code, price} = r.value;
      const idx = rows.findIndex(x=>x.code===code);
      if(idx>=0){ rows[idx].cur = price || rows[idx].cur || 0; }
    }
  });
  saveRows(rows);
  $$('#tbody tr').forEach((tr,i)=> tr.querySelector('.cur').value = rows[i].cur?fmt(rows[i].cur):'');
  updateProfits();
}

// ===== 폴링 =====
function tick(){
  if(!$('#liveToggle').checked) return;
  const codes = rows.map(r=>r.code).filter(Boolean);
  if(!codes.length) return;
  fetchPricesAuto(codes);
}
function startPolling(){
  stopPolling();
  if(!$('#liveToggle').checked) return;
  const sec = Math.max(2, Number($('#pollSec').value)||10);
  timer = setInterval(tick, sec*1000);
  tick();
}
function stopPolling(){ if(timer){clearInterval(timer); timer=null;} }

// ===== 초기 =====
$('#addRowBtn').addEventListener('click', ()=>{ rows.push({code:'',name:'',avg:0,qty:0,cur:0,fix:0,invest:0}); saveRows(rows); render(); });
$('#saveBtn').addEventListener('click', ()=>{ settings.apiBase=$('#apiBase').value.trim(); settings.apiMode=$('#apiMode').value; saveSettings(settings); saveRows(rows); alert('저장되었습니다.'); });
$('#liveToggle').addEventListener('change', ()=>{ $$('#tbody .cur').forEach(inp=> inp.readOnly = $('#liveToggle').checked); if($('#liveToggle').checked) startPolling(); else stopPolling(); });
$('#pollSec').addEventListener('change', startPolling);
$('#apiBase').addEventListener('change', ()=>{ settings.apiBase=$('#apiBase').value.trim(); saveSettings(settings); });
$('#apiMode').addEventListener('change', ()=>{ settings.apiMode=$('#apiMode').value; saveSettings(settings); });

if(!rows.length){
  rows = [
    {code:'010620.KS', name:'삼성전자',   avg:238000, qty:5,  cur:0, fix:0, invest:238000*5},
    {code:'015760.KS', name:'한국전력',   avg:43150,  qty:51, cur:0, fix:0, invest:43150*51},
    {code:'000660.KS', name:'SK하이닉스', avg:0,      qty:0,  cur:0, fix:0, invest:0},
  ];
  saveRows(rows);
}
render();
startPolling();
</script>
</body>
</html>
