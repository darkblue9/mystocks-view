<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>간단 포트 감시 (v1.4-proxy)</title>
  <style>
    :root{ --fs:12px; --pad:6px; --ip:4px; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#fafafa; color:#111; margin:0; font-size:var(--fs);}
    .wrap{max-width:1200px; margin:12px auto; padding:0 8px;}
    .card{background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.05); padding:10px;}
    table{width:100%; border-collapse:collapse; font-size:inherit}
    th,td{padding:var(--pad); border-bottom:1px solid #eee; vertical-align:middle;}
    th{text-align:left; color:#666; font-weight:600}
    input,button{font:inherit}
    input[type=text],input[type=number]{border:1px solid #ccc; border-radius:8px; padding:var(--ip) 6px; background:#fff;}
    input[readonly]{background:#f5f5f5; color:#555}
    .right{text-align:right}
    .muted{color:#666; font-size:11px}
    .pos{color:#087443; font-weight:600}
    .neg{color:#c11a3a; font-weight:600}
    .row-tools{white-space:nowrap; display:flex; gap:4px; align-items:center; justify-content:flex-end}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:end; margin-bottom:8px}
    .controls > div{display:flex; flex-direction:column; gap:4px}
    .pill{border-radius:999px; padding:4px 10px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer}
    .symcell{display:flex; flex-direction:column; gap:4px; min-width:240px}
    .symname{font-size:11px; color:#333; line-height:1.2; cursor:pointer}
    .symname.placeholder{color:#999}
    .name-editor{display:none; gap:6px}
    .name-editor input{width:46%; min-width:120px}
    .dense .controls{gap:6px}
    .dense th, .dense td{padding:4px 6px}
    .dense input[type=text], .dense input[type=number]{padding:3px 5px}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
    .top-actions{display:flex; gap:6px; align-items:center}
    .switch{display:inline-flex; gap:6px; align-items:center; font-size:11px}
    #rowsInfo{font-size:11px; color:#555}
    .tiny{font-size:10px; opacity:.8}
    .tag{display:inline-block; border:1px solid #bbb; border-radius:999px; padding:0 6px; font-size:10px; margin-left:6px; color:#444}
    .gray{color:#444}
    .note{font-size:11px; color:#444; margin-bottom:8px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="controls">
    <div>
      <label class="muted">Finnhub API Key (프록시 불필요)</label>
      <input id="apiKey" placeholder="(프로시 사용 시 서버에 키 넣으면 브라우저에 필요 없음)" style="width:360px" />
    </div>
    <div>
      <label class="muted">폴링(초) · 최소 5</label>
      <input id="pollSec" type="number" min="5" value="15" style="width:80px" />
    </div>
    <div class="top-actions">
      <button id="toggleBtn" class="pill">실시간 ON</button>
      <button id="addBtn" class="pill">+ 종목 추가</button>
      <label class="switch"><input id="denseChk" type="checkbox" checked /> 밀집 모드</label>
    </div>
  </div>

  <div class="note">
    이제 기본 동작은 **로컬 프록시 서버 (http://localhost:3000)** 를 이용합니다. 프록시를 띄우면 Finnhub 무료 호출제한과 CORS 문제를 피할 수 있습니다. (아래에 서버 코드 & 실행법 제공)
  </div>

  <div class="muted" style="margin-bottom:6px">
    6자리 코드만 입력해도 .KS/.KQ 자동 감지 + 한글/영문 종목명 자동 표시.
    <span id="rowsInfo"></span>
  </div>

  <div class="card dense" id="card">
    <div class="topbar">
      <div class="muted">임계치: +30,000원 / -10,000원 도달 시 알림</div>
      <div><b>총 손익: <span id="totalPnl">0</span>원</b></div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:320px">종목(코드/심볼 · 이름)</th>
          <th>매수가(원)</th>
          <th>주수</th>
          <th>투입금액</th>
          <th>현재가/고정가</th>
          <th>손익(원)</th>
          <th>손익(%)</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr><td colspan="8" class="muted">* 데이터는 로컬에만 저장. · 프록시 사용 권장(아래 설명). · 고정가 입력 시 해당 행은 실시간 대신 고정가로 손익 계산.</td></tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
  // ===== 설정: 프록시 모드 (권장) =====
  // 프록시 주소: 로컬에서 실행한 서버가 기본값입니다.
  const USE_PROXY = true;
  const PROXY_BASE = 'http://localhost:3000/api'; // 프록시를 로컬에서 띄우면 이대로 사용

  // ===== 유틸 & 상태 =====
  const $ = (s)=>document.querySelector(s);
  const krw = (n)=> (Number(n)||0).toLocaleString('ko-KR',{maximumFractionDigits:0});
  const load = (k, v=null)=>{try{const s=localStorage.getItem(k); return s?JSON.parse(s):v;}catch{return v}};
  const save = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
  const isKorean = (s)=> /[\u3131-\uD7A3]/.test(String(s||''));
  const isEnglishish = (s)=> /^[A-Z0-9 .,&()'/-]+$/.test(String(s||'').trim());

  const DEFAULT_ROWS = [
    { symbol: '005930.KS', code: '005930', name_ko: '삼성전자', name_en: 'Samsung Electronics', buy: 70000, shares: 10, fixed: null },
    { symbol: '005380.KS', code: '005380', name_ko: '현대차', name_en: 'Hyundai Motor', buy: 200000, shares: 4, fixed: null }
  ];

  let apiKey = load('finnhub_api_key','');
  let pollSec = load('poll_sec', 15);
  let rows = load('positions_v14', null) || load('positions', null) || DEFAULT_ROWS;
  let running = true;
  let timer = null;
  const notified = {};
  const enTried = {};

  $('#apiKey').value = apiKey;
  $('#pollSec').value = pollSec;
  $('#denseChk').checked = true;
  $('#denseChk').onchange = (e)=>{
    const card = $('#card');
    if (e.target.checked) card.classList.add('dense'); else card.classList.remove('dense');
  };

  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  // 입력/편집 처리
  let typingTimer = 0;
  document.addEventListener('input', (e)=>{
    const t = e.target;
    if (t.dataset && t.dataset.idx !== undefined){
      const idx = Number(t.dataset.idx);
      const key = t.dataset.key;
      if (key === 'symbolOrCode') {
        const raw = t.value.trim();
        rows[idx].__raw = raw;
        clearTimeout(typingTimer);
        typingTimer = setTimeout(async ()=>{
          const resolved = await resolveSymbolAndNames(raw);
          if (resolved) {
            rows[idx].symbol = resolved.symbol;
            rows[idx].code = resolved.code || raw;
            if (resolved.name_ko) rows[idx].name_ko = resolved.name_ko;
            if (resolved.name_en) rows[idx].name_en = resolved.name_en;
          } else {
            rows[idx].symbol = raw;
            rows[idx].code = raw;
          }
          persist(); render(); fetchQuotes();
        }, 250);
      } else if (key === 'buy' || key === 'shares') {
        rows[idx][key] = Number(t.value)||0;
        persist(); render();
      } else if (key === 'name_ko' || key === 'name_en') {
        rows[idx][key] = t.value;
        persist(); render();
      } else if (key === 'fixed') {
        const v = String(t.value).trim();
        rows[idx].fixed = v==='' ? null : Number(v)||null;
        persist(); render();
      }
    }
  });

  document.addEventListener('click', (e)=>{
    const del = e.target.getAttribute('data-del');
    const mv = e.target.getAttribute('data-move');
    const fillEn = e.target.getAttribute('data-fill-en');
    const nameDiv = e.target.closest('.symname');
    if (del !== null){
      rows.splice(Number(del),1);
      persist(); render();
      return;
    }
    if (mv){
      const idx = Number(e.target.getAttribute('data-idx'));
      if (mv==='up' && idx>0){
        [rows[idx-1], rows[idx]] = [rows[idx], rows[idx-1]];
      } else if (mv==='down' && idx<rows.length-1){
        [rows[idx+1], rows[idx]] = [rows[idx], rows[idx+1]];
      }
      persist(); render();
      return;
    }
    if (fillEn !== null){
      const r = rows[Number(fillEn)];
      autoFillEnglish(r).then(()=>{ persist(); render(); });
      return;
    }
    if (nameDiv){
      const idx = Number(nameDiv.dataset.idx);
      const editor = document.querySelector(`.name-editor[data-idx='${idx}']`);
      if (editor){ editor.style.display = editor.style.display==='flex' ? 'none' : 'flex'; }
      return;
    }
  });

  document.addEventListener('keydown', (e)=>{
    const t = e.target;
    if (t.dataset && (t.dataset.key==='name_ko' || t.dataset.key==='name_en')){
      if (e.key === 'Enter'){
        const idx = Number(t.dataset.idx);
        const editor = document.querySelector(`.name-editor[data-idx='${idx}']`);
        if (editor) editor.style.display = 'none';
      }
    }
  });
  document.addEventListener('blur', (e)=>{
    const t = e.target;
    if (t.dataset && (t.dataset.key==='name_ko' || t.dataset.key==='name_en')){
      const idx = Number(t.dataset.idx);
      const editor = document.querySelector(`.name-editor[data-idx='${idx}']`);
      if (editor) setTimeout(()=>{ editor.style.display = 'none'; }, 100);
    }
  }, true);

  async function resolveSymbolAndNames(input){
    if (!input) return null;
    if (/\.(KS|KQ)$/i.test(input)) {
      const prof = await fetchProfile(input);
      const desc = await searchDesc(input);
      const { name_ko, name_en } = pickKoEn(prof?.name, desc);
      return { symbol: input.toUpperCase(), name_ko, name_en, code: input.slice(0,6) };
    }
    if (/^\d{6}$/.test(input)) {
      const found = await searchKR(input);
      if (found) return found;
    }
    const found = await searchKR(input);
    if (found) return found;
    return null;
  }

  function pickKoEn(primary, secondary){
    let ko='', en='';
    if (isKorean(primary)) ko = primary; else if (isEnglishish(primary)) en = primary||'';
    if (isKorean(secondary)) ko = ko||secondary; else if (isEnglishish(secondary)) en = en||secondary||'';
    return { name_ko: ko, name_en: en };
  }

  async function searchDesc(symbolOrQuery){
    try{
      if (USE_PROXY){
        const res = await fetch(`${PROXY_BASE}/search?q=${encodeURIComponent(symbolOrQuery)}`);
        if (!res.ok) return '';
        const j = await res.json();
        return j.description || j.result?.[0]?.description || '';
      } else {
        if (!apiKey) return '';
        const url = `https://finnhub.io/api/v1/search?q=${encodeURIComponent(symbolOrQuery)}&token=${encodeURIComponent(apiKey)}`;
        const res = await fetch(url);
        if(!res.ok) return '';
        const j = await res.json();
        return j.result?.[0]?.description || '';
      }
    }catch{ return ''; }
  }

  async function searchKR(q){
    try{
      if (USE_PROXY){
        const res = await fetch(`${PROXY_BASE}/search?q=${encodeURIComponent(q)}`);
        if (!res.ok) return null;
        const j = await res.json();
        const items = (j.result||[]).filter(it=>/\.K[SQ]$/i.test(it.symbol||''));
        if (items.length===0) return null;
        const code = (/^\d{6}$/.test(q)? q : null);
        let pick = null;
        if (code){
          pick = items.find(it => (it.symbol||'').startsWith(code)) || null;
        }
        if (!pick) pick = items[0];
        const prof = await fetchProfile(pick.symbol);
        const { name_ko, name_en } = pickKoEn(prof?.name, pick.description);
        return { symbol: pick.symbol.toUpperCase(), name_ko, name_en, code: (pick.symbol||'').slice(0,6) };
      } else {
        if (!apiKey) return null;
        const res = await fetch(`https://finnhub.io/api/v1/search?q=${encodeURIComponent(q)}&token=${encodeURIComponent(apiKey)}`);
        if(!res.ok) return null;
        const j = await res.json();
        const items = (j.result||[]).filter(it=>/\.K[SQ]$/i.test(it.symbol||''));
        if (items.length===0) return null;
        const code = (/^\d{6}$/.test(q)? q : null);
        let pick = null;
        if (code){
          pick = items.find(it => (it.symbol||'').startsWith(code)) || null;
        }
        if (!pick) pick = items[0];
        const prof = await fetchProfile(pick.symbol);
        const { name_ko, name_en } = pickKoEn(prof?.name, pick.description);
        return { symbol: pick.symbol.toUpperCase(), name_ko, name_en, code: (pick.symbol||'').slice(0,6) };
      }
    }catch(e){ console.error(e); return null; }
  }

  async function fetchProfile(symbol){
    try{
      if (USE_PROXY){
        const res = await fetch(`${PROXY_BASE}/profile?symbol=${encodeURIComponent(symbol)}`);
        if (!res.ok) return null;
        const j = await res.json();
        return j || null;
      } else {
        if (!apiKey) return null;
        const url = `https://finnhub.io/api/v1/stock/profile2?symbol=${encodeURIComponent(symbol)}&token=${encodeURIComponent(apiKey)}`;
        const res = await fetch(url);
        if(!res.ok) return null;
        const j = await res.json();
        return j||null;
      }
    }catch(e){ console.error(e); return null; }
  }

  function effectivePrice(r){
    if (r.fixed && Number(r.fixed)>0) return Number(r.fixed);
    const q = quotes[r.symbol]?.c || 0;
    return q;
  }

  function amountOf(r){
    return Math.round(Number(r.buy||0) * Number(r.shares||0));
  }

  function persist(){ save('positions_v14', rows); save('finnhub_api_key', apiKey); save('poll_sec', pollSec); }

  function render(){
    const tbody = $('#tbody');
    tbody.innerHTML = '';

    setTimeout(()=>{
      const rowsCount = document.querySelectorAll('#tbody tr').length;
      $('#rowsInfo').textContent = ` · 표시 행: ${rowsCount}개`;
    },0);

    let total = 0;
    rows.forEach((r, idx)=>{
      const avg = Number(r.buy||0);
      const amt = amountOf(r);
      const cur = effectivePrice(r);
      const curVal = cur * Number(r.shares||0);
      const pnl = curVal - amt;
      total += pnl;
      const pct = avg? ((cur-avg)/avg*100):0;

      if (r.symbol && r.name_ko && !r.name_en && !enTried[r.symbol]) {
        enTried[r.symbol] = true;
        autoFillEnglish(r).then(()=>{ persist(); render(); });
      }

      const showSymbol = r.symbol || r.__raw || '';
      const ko = r.name_ko || '';
      const en = r.name_en || '';
      const nameText = (ko || en) ? `${ko || '-'} / ${en || '-'}` : '이름 없음 (클릭해 입력)';
      const fixedTag = (r.fixed && Number(r.fixed)>0) ? `<span class="tag">고정</span>` : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="symcell">
          <input data-idx="${idx}" data-key="symbolOrCode" value="${showSymbol}" placeholder="예: 005930 또는 005930.KS" />
          <div class="symname ${ko||en?'':'placeholder'}" data-idx="${idx}">${nameText}</div>
          <div class="name-editor" data-idx="${idx}" style="display:none">
            <input data-idx="${idx}" data-key="name_ko" type="text" placeholder="한글명" value="${ko}"/>
            <input data-idx="${idx}" data-key="name_en" type="text" placeholder="영문명" value="${en}"/>
            <button class="pill tiny" data-fill-en="${idx}">영문 자동</button>
          </div>
        </td>
        <td class="right"><input data-idx="${idx}" data-key="buy" type="number" value="${r.buy||0}" style="width:100px"/></td>
        <td class="right"><input data-idx="${idx}" data-key="shares" type="number" value="${r.shares||0}" style="width:70px"/></td>
        <td class="right"><input value="${krw(amt)}" readonly style="width:110px"/></td>
        <td class="right">
          <div style="display:flex; gap:4px; align-items:center; justify-content:flex-end">
            <input data-idx="${idx}" data-key="fixed" type="number" placeholder="${cur?krw(cur):''}" value="${(r.fixed||'')}" style="width:90px"/>
            ${fixedTag}
          </div>
          <div class="muted right">${cur? '시세: '+krw(cur): '-'}</div>
        </td>
        <td class="right ${pnl>0?'pos':pnl<0?'neg':''}">${krw(pnl)}</td>
        <td class="right ${pct>0?'pos':pct<0?'neg':''}">${avg? pct.toFixed(2)+'%':'-'}</td>
        <td class="row-tools right">
          <button class="pill tiny" data-move="up" data-idx="${idx}">▲</button>
          <button class="pill tiny" data-move="down" data-idx="${idx}">▼</button>
          <button class="pill" data-del="${idx}">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    $('#totalPnl').textContent = krw(total);
  }

  async function autoFillEnglish(r){
    if (!r || !r.symbol) return;
    const qList = [r.code, r.symbol, r.name_ko];
    for (const q of qList){
      const desc = await searchDesc(q);
      if (isEnglishish(desc) && desc.length > 2){
        r.name_en = desc;
        return;
      }
    }
  }

  // ==== 시세 조회: proxy 또는 direct ====
  let quotes = {};
  async function fetchQuotes(){
    const syms = rows.map(r=>r.symbol).filter(Boolean);
    if (syms.length===0) return;
    try{
      if (USE_PROXY){
        // call server with comma-separated symbols
        const url = `${PROXY_BASE}/quote?symbols=${encodeURIComponent(syms.join(','))}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('proxy error '+res.status);
        const j = await res.json();
        // j is { symbol: { c: current,... }, ... }
        quotes = j || {};
      } else {
        if (!apiKey) return;
        const results = await Promise.all(syms.map(async (sym)=>{
          const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(sym)}&token=${encodeURIComponent(apiKey)}`);
          if(!res.ok) throw new Error(sym+': http '+res.status);
          const j = await res.json();
          return [sym, j];
        }));
        quotes = Object.fromEntries(results);
      }
      checkNotify();
      render();
    }catch(err){
      console.error(err);
      // keep old quotes but render so user sees placeholders
      render();
    }
  }

  function checkNotify(){
    rows.forEach(r=>{
      if(!r.symbol) return;
      const cur = effectivePrice(r);
      if(!cur) return;
      const pnl = cur * Number(r.shares||0) - amountOf(r);
      const key = r.symbol;
      const state = notified[key];
      if (pnl >= 30000 && state !== 'up') {
        notify(`[상승] ${r.symbol}`, `손익 +${krw(pnl)}원, 현재가 ${krw(cur)}원${r.fixed? ' (고정)': ''}`);
        notified[key] = 'up';
      } else if (pnl <= -10000 && state !== 'down') {
        notify(`[하락] ${r.symbol}`, `손익 ${krw(pnl)}원, 현재가 ${krw(cur)}원${r.fixed? ' (고정)': ''}`);
        notified[key] = 'down';
      }
      if (pnl < 30000 && pnl > -10000) notified[key] = undefined;
    });
  }

  function notify(title, body){
    if(!('Notification' in window)) return;
    if(Notification.permission==='granted') new Notification(title, { body });
  }

  function effectivePrice(r){
    if (r.fixed && Number(r.fixed)>0) return Number(r.fixed);
    const q = quotes[r.symbol]?.c || 0;
    return q;
  }

  function amountOf(r){
    return Math.round(Number(r.buy||0) * Number(r.shares||0));
  }

  function persist(){ save('positions_v14', rows); save('finnhub_api_key', apiKey); save('poll_sec', pollSec); }

  function kick(){
    clearInterval(timer);
    fetchQuotes();
    timer = setInterval(fetchQuotes, Math.max(5, Number(pollSec))*1000);
  }

  // top controls
  $('#addBtn').onclick = ()=>{ rows.push({symbol:'', code:'', name_ko:'', name_en:'', buy:0, shares:0, fixed:null}); persist(); render(); };
  $('#toggleBtn').onclick = ()=>{ running = !running; $('#toggleBtn').textContent = running? '실시간 ON':'일시정지'; if(running){kick()} else {clearInterval(timer);} };
  $('#apiKey').onchange = (e)=>{ apiKey = e.target.value; save('finnhub_api_key', apiKey); };
  $('#pollSec').onchange = (e)=>{ let v = Number(e.target.value)||15; v = Math.max(5,v); pollSec=v; save('poll_sec', pollSec); if(running){kick()} };

  // initial
  persist();
  render();
  kick();
</script>
</body>
</html>
