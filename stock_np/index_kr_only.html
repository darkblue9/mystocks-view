<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>간단 포트 감시 (v2.0 · 한국주식 전용 · 키/설치 불필요)</title>
  <style>
    :root{ --fs:12px; --pad:6px; --ip:4px; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; background:#fafafa; color:#111; margin:0; font-size:var(--fs);}
    .wrap{max-width:1200px; margin:12px auto; padding:0 8px;}
    .card{background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.05); padding:10px;}
    table{width:100%; border-collapse:collapse; font-size:inherit}
    th,td{padding:var(--pad); border-bottom:1px solid #eee; vertical-align:middle;}
    th{text-align:left; color:#666; font-weight:600}
    input,button{font:inherit}
    input[type=text],input[type=number]{border:1px solid #ccc; border-radius:8px; padding:var(--ip) 6px; background:#fff;}
    input[readonly]{background:#f5f5f5; color:#555}
    .right{text-align:right}
    .muted{color:#666; font-size:11px}
    .pos{color:#087443; font-weight:600}
    .neg{color:#c11a3a; font-weight:600}
    .row-tools{white-space:nowrap; display:flex; gap:4px; align-items:center; justify-content:flex-end}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:end; margin-bottom:8px}
    .controls > div{display:flex; flex-direction:column; gap:4px}
    .pill{border-radius:999px; padding:4px 10px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer}
    .symcell{display:flex; flex-direction:column; gap:4px; min-width:240px}
    .symname{font-size:11px; color:#333; line-height:1.2; cursor:pointer}
    .symname.placeholder{color:#999}
    .name-editor{display:none; gap:6px}
    .name-editor input{width:46%; min-width:120px}
    .dense .controls{gap:6px}
    .dense th, .dense td{padding:4px 6px}
    .dense input[type=text], .dense input[type=number]{padding:3px 5px}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
    .top-actions{display:flex; gap:6px; align-items:center}
    .switch{display:inline-flex; gap:6px; align-items:center; font-size:11px}
    #rowsInfo{font-size:11px; color:#555}
    .tiny{font-size:10px; opacity:.8}
    .tag{display:inline-block; border:1px solid #bbb; border-radius:999px; padding:0 6px; font-size:10px; margin-left:6px; color:#444}
  </style>
</head>
<body>
<div class="wrap">
  <div class="controls">
    <div class="top-actions">
      <button id="toggleBtn" class="pill">실시간 ON</button>
      <button id="addBtn" class="pill">+ 종목 추가</button>
      <label class="switch"><input id="denseChk" type="checkbox" checked /> 밀집 모드</label>
    </div>
  </div>

  <div class="muted" style="margin-bottom:6px">
    6자리 코드만 입력해도 <b>.KS/.KQ 자동 감지</b> + <b>영문 종목명</b> 자동 표시. (예: 005930 → 005930.KS → Samsung Electronics) · 한국주식 전용 (Yahoo Finance 사용, API 키/설치 불필요)
    <span id="rowsInfo"></span>
  </div>

  <div class="card dense" id="card">
    <div class="topbar">
      <div class="muted">임계치: +30,000원 / -10,000원 도달 시 알림</div>
      <div><b>총 손익: <span id="totalPnl">0</span>원</b></div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:320px">종목(코드/심볼 · 이름)</th>
          <th>매수가(원)</th>
          <th>주수</th>
          <th>투입금액</th>
          <th>현재가/고정가</th>
          <th>손익(원)</th>
          <th>손익(%)</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr><td colspan="8" class="muted">* 데이터는 로컬에만 저장. · 이름줄 클릭 → 직접 편집(Enter/밖 클릭 시 저장·적용). · 고정가 입력 시 해당 행은 실시간 대신 고정가로 손익 계산.</td></tr>
      </tfoot>
    </table>
  </div>
</div>

<script>
  // ===== Yahoo Finance KR only (no key) =====
  const YF_QUOTE = (symbols)=>`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols.join(','))}`;
  const YF_SEARCH = (q)=>`https://query2.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(q)}`;

  const $ = (s)=>document.querySelector(s);
  const krw = (n)=> (Number(n)||0).toLocaleString('ko-KR',{maximumFractionDigits:0});
  const load = (k, v=null)=>{try{const s=localStorage.getItem(k); return s?JSON.parse(s):v;}catch{return v}};
  const save = (k, v)=> localStorage.setItem(k, JSON.stringify(v));
  const isKorean = (s)=> /[\u3131-\uD7A3]/.test(String(s||''));
  const isEnglishish = (s)=> /^[A-Z0-9 .,&()'/-]+$/.test(String(s||'').trim());

  const DEFAULT_ROWS = [
    { symbol: '005930.KS', code: '005930', name_ko: '', name_en: 'Samsung Electronics', buy: 70000, shares: 10, fixed: null },
    { symbol: '005380.KS', code: '005380', name_ko: '', name_en: 'Hyundai Motor', buy: 200000, shares: 4, fixed: null }
  ];

  let pollSec = load('poll_sec', 10);
  let rows = load('positions_v20', DEFAULT_ROWS);
  let running = true;
  let timer = null;
  const notified = {};

  $('#denseChk').checked = true;
  $('#denseChk').onchange = (e)=>{
    const card = $('#card');
    if (e.target.checked) card.classList.add('dense'); else card.classList.remove('dense');
  };

  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }

  // 입력/편집
  let typingTimer = 0;
  document.addEventListener('input', (e)=>{
    const t = e.target;
    if (t.dataset && t.dataset.idx !== undefined){
      const idx = Number(t.dataset.idx);
      const key = t.dataset.key;
      if (key === 'symbolOrCode') {
        const raw = t.value.trim();
        rows[idx].__raw = raw;
        clearTimeout(typingTimer);
        typingTimer = setTimeout(async ()=>{
          const resolved = await resolveSymbolAndNames(raw);
          if (resolved) {
            rows[idx].symbol = resolved.symbol;
            rows[idx].code = resolved.code || raw.slice(0,6);
            if (resolved.name_en) rows[idx].name_en = resolved.name_en;
          } else {
            rows[idx].symbol = raw;
            rows[idx].code = raw.slice(0,6);
          }
          persist(); render(); fetchQuotes();
        }, 250);
      } else if (key === 'buy' || key === 'shares') {
        rows[idx][key] = Number(t.value)||0;
        persist(); render();
      } else if (key === 'name_ko' || key === 'name_en') {
        rows[idx][key] = t.value;
        persist(); render();
      } else if (key === 'fixed') {
        const v = String(t.value).trim();
        rows[idx].fixed = v==='' ? null : Number(v)||null;
        persist(); render();
      }
    }
  });

  document.addEventListener('click', (e)=>{
    const del = e.target.getAttribute('data-del');
    const mv = e.target.getAttribute('data-move');
    const fillEn = e.target.getAttribute('data-fill-en');
    const nameDiv = e.target.closest('.symname');
    if (del !== null){
      rows.splice(Number(del),1);
      persist(); render();
      return;
    }
    if (mv){
      const idx = Number(e.target.getAttribute('data-idx'));
      if (mv==='up' && idx>0){
        [rows[idx-1], rows[idx]] = [rows[idx], rows[idx-1]];
      } else if (mv==='down' && idx<rows.length-1){
        [rows[idx+1], rows[idx]] = [rows[idx], rows[idx+1]];
      }
      persist(); render();
      return;
    }
    if (fillEn !== null){
      const r = rows[Number(fillEn)];
      autoFillEnglish(r).then(()=>{ persist(); render(); });
      return;
    }
    if (nameDiv){
      const idx = Number(nameDiv.dataset.idx);
      const editor = document.querySelector(`.name-editor[data-idx='${idx}']`);
      if (editor){ editor.style.display = editor.style.display==='flex' ? 'none' : 'flex'; }
      return;
    }
  });

  document.addEventListener('keydown', (e)=>{
    const t = e.target;
    if (t.dataset && (t.dataset.key==='name_ko' || t.dataset.key==='name_en')){
      if (e.key === 'Enter'){
        const idx = Number(t.dataset.idx);
        const editor = document.querySelector(`.name-editor[data-idx='${idx}']`);
        if (editor) editor.style.display = 'none';
      }
    }
  });
  document.addEventListener('blur', (e)=>{
    const t = e.target;
    if (t.dataset && (t.dataset.key==='name_ko' || t.dataset.key==='name_en')){
      const idx = Number(t.dataset.idx);
      const editor = document.querySelector(`.name-editor[data-idx='${idx}']`);
      if (editor) setTimeout(()=>{ editor.style.display = 'none'; }, 120);
    }
  }, true);

  async function resolveSymbolAndNames(input){
    if (!input) return null;
    // 이미 KS/KQ 붙어 있으면 그대로 확인
    if (/\.(KS|KQ)$/i.test(input)) {
      const info = await fetchYahooQuote([input.toUpperCase()]);
      const it = info.map[input.toUpperCase()];
      if (it && it.c>0) return { symbol: input.toUpperCase(), code: input.slice(0,6), name_en: it.name };
      return null;
    }
    // 6자리 숫자면 KS/KQ 둘 다 시도
    if (/^\d{6}$/.test(input)) {
      const ks = `${input}.KS`, kq = `${input}.KQ`;
      const info = await fetchYahooQuote([ks, kq]);
      if (info.map[ks] && info.map[ks].c>0) return { symbol: ks, code: input, name_en: info.map[ks].name };
      if (info.map[kq] && info.map[kq].c>0) return { symbol: kq, code: input, name_en: info.map[kq].name };
      // 검색 API로 최후 보완
      const s = await yahooSearch(input);
      return s;
    }
    // 문자열 검색
    const s = await yahooSearch(input);
    return s;
  }

  async function yahooSearch(q){
    try{
      const res = await fetch(YF_SEARCH(q));
      if(!res.ok) return null;
      const j = await res.json();
      const it = (j.quotes||[]).find(r=>/\.K[QS]$/.test(r.symbol||''));
      if (!it) return null;
      return { symbol: it.symbol, code: (it.symbol||'').slice(0,6), name_en: it.shortname || it.longname || it.symbol };
    }catch{ return null; }
  }

  function persist(){ save('positions_v20', rows); save('poll_sec', pollSec); }

  function amountOf(r){ return Math.round(Number(r.buy||0) * Number(r.shares||0)); }
  function effectivePrice(r){
    if (r.fixed && Number(r.fixed)>0) return Number(r.fixed);
    const q = quotes[r.symbol]?.c || 0;
    return q;
  }

  function render(){
    const tbody = $('#tbody');
    tbody.innerHTML = '';

    setTimeout(()=>{
      const rowsCount = document.querySelectorAll('#tbody tr').length;
      $('#rowsInfo').textContent = ` · 표시 행: ${rowsCount}개`;
    },0);

    let total = 0;
    rows.forEach((r, idx)=>{
      const avg = Number(r.buy||0);
      const amt = amountOf(r);
      const cur = effectivePrice(r);
      const curVal = cur * Number(r.shares||0);
      const pnl = curVal - amt;
      total += pnl;
      const pct = avg? ((cur-avg)/avg*100):0;

      const showSymbol = r.symbol || r.__raw || '';
      const ko = r.name_ko || '';
      const en = r.name_en || '';
      const nameText = (ko || en) ? `${ko || '-'} / ${en || '-'}` : '이름 없음 (클릭해 입력)';
      const fixedTag = (r.fixed && Number(r.fixed)>0) ? `<span class="tag">고정</span>` : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="symcell">
          <input data-idx="${idx}" data-key="symbolOrCode" value="${showSymbol}" placeholder="예: 005930 또는 005930.KS" />
          <div class="symname ${ko||en?'':'placeholder'}" data-idx="${idx}">${nameText}</div>
          <div class="name-editor" data-idx="${idx}" style="display:none">
            <input data-idx="${idx}" data-key="name_ko" type="text" placeholder="한글명" value="${ko}"/>
            <input data-idx="${idx}" data-key="name_en" type="text" placeholder="영문명" value="${en}"/>
          </div>
        </td>
        <td class="right"><input data-idx="${idx}" data-key="buy" type="number" value="${r.buy||0}" style="width:100px"/></td>
        <td class="right"><input data-idx="${idx}" data-key="shares" type="number" value="${r.shares||0}" style="width:70px"/></td>
        <td class="right"><input value="${krw(amt)}" readonly style="width:110px"/></td>
        <td class="right">
          <div style="display:flex; gap:4px; align-items:center; justify-content:flex-end">
            <input data-idx="${idx}" data-key="fixed" type="number" placeholder="${cur?krw(cur):''}" value="${(r.fixed||'')}" style="width:90px"/>
            ${fixedTag}
          </div>
          <div class="muted right">${cur? '시세: '+krw(cur): '-'}</div>
        </td>
        <td class="right ${pnl>0?'pos':pnl<0?'neg':''}">${krw(pnl)}</td>
        <td class="right ${pct>0?'pos':pct<0?'neg':''}">${avg? pct.toFixed(2)+'%':'-'}</td>
        <td class="row-tools right">
          <button class="pill tiny" data-move="up" data-idx="${idx}">▲</button>
          <button class="pill tiny" data-move="down" data-idx="${idx}">▼</button>
          <button class="pill" data-del="${idx}">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    $('#totalPnl').textContent = krw(total);
  }

  // ===== Yahoo quote fetch (batch) =====
  let quotes = {}; // { sym: {c, name} }
  async function fetchYahooQuote(symbols){
    if (!symbols || symbols.length===0) return {map:{}};
    const res = await fetch(YF_QUOTE(symbols));
    if(!res.ok) return {map:{}};
    const j = await res.json();
    const out = {};
    (j.quoteResponse?.result||[]).forEach(it=>{
      const sym = it.symbol;
      out[sym] = {
        c: Number(it.regularMarketPrice||0),
        name: it.longName || it.shortName || sym
      };
    });
    return {map: out};
  }

  async function fetchQuotes(){
    const syms = rows.map(r=>r.symbol).filter(Boolean);
    if (syms.length===0) return;
    try{
      const info = await fetchYahooQuote(syms);
      quotes = info.map;
      checkNotify();
      render();
    }catch(e){
      console.error(e);
      render();
    }
  }

  function checkNotify(){
    rows.forEach(r=>{
      if(!r.symbol) return;
      const cur = effectivePrice(r);
      if(!cur) return;
      const pnl = cur * Number(r.shares||0) - amountOf(r);
      const key = r.symbol;
      const state = notified[key];
      if (pnl >= 30000 && state !== 'up') {
        notify(`[상승] ${r.symbol}`, `손익 +${krw(pnl)}원, 현재가 ${krw(cur)}원${r.fixed? ' (고정)': ''}`);
        notified[key] = 'up';
      } else if (pnl <= -10000 && state !== 'down') {
        notify(`[하락] ${r.symbol}`, `손익 ${krw(pnl)}원, 현재가 ${krw(cur)}원${r.fixed? ' (고정)': ''}`);
        notified[key] = 'down';
      }
      if (pnl < 30000 && pnl > -10000) notified[key] = undefined;
    });
  }

  function notify(title, body){
    if(!('Notification' in window)) return;
    if(Notification.permission==='granted') new Notification(title, { body });
  }

  // top
  $('#addBtn').onclick = ()=>{ rows.push({symbol:'', code:'', name_ko:'', name_en:'', buy:0, shares:0, fixed:null}); persist(); render(); };
  $('#toggleBtn').onclick = ()=>{ running = !running; $('#toggleBtn').textContent = running? '실시간 ON':'일시정지'; if(running){kick()} else {clearInterval(timer);} };

  function kick(){
    clearInterval(timer);
    fetchQuotes();
    timer = setInterval(fetchQuotes, Math.max(5, Number(pollSec))*1000);
  }

  // init
  persist();
  render();
  kick();
</script>
</body>
</html>
