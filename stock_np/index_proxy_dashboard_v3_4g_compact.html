<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 v3.4g (Compact Plain Inputs)</title>
<style>
  body{margin:0;padding:12px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Malgun Gothic,sans-serif}
  .top{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:12px}
  label{font-size:12px;color:#555;display:flex;flex-direction:column;gap:4px}
  input, select, button{font:inherit}
  input[type="text"], input[type="number"]{width:100%;box-sizing:border-box}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{border-bottom:1px solid #e5e7eb;padding:6px 4px;text-align:center}
  th{background:#f8fafc}
  td input{width:100%;border:1px solid #ddd;padding:2px 3px}
  td input[readonly]{background:#f9fafb}
  td.num input, td.num span{text-align:right}
  .status{font-size:12px;padding:2px 6px;border-radius:4px;background:#ecfdf5;color:#065f46}
  .bad{background:#fef2f2;color:#991b1b}
  .profit-pos{color:#059669;font-weight:700}
  .profit-neg{color:#ef4444;font-weight:700}
  .mini{font-size:12px;color:#555}
  .tot{display:flex;justify-content:flex-end;gap:8px;margin-top:8px}
  th:nth-child(1){width:90px}
  th:nth-child(2){width:110px}
  th:nth-child(3),th:nth-child(4),th:nth-child(5),th:nth-child(6),th:nth-child(7),th:nth-child(8),th:nth-child(9){width:95px}
  th:nth-child(10){width:60px}
</style>
</head>
<body>
<div class="top">
  <label>프록시 주소
    <input id="apiBase" type="text" placeholder="http://localhost:3000">
  </label>
  <label>엔드포인트
    <select id="apiMode">
      <option value="auto">자동 감지</option>
      <option value="multi">멀티</option>
      <option value="single">단건</option>
    </select>
  </label>
  <label>코드 파라미터명
    <input id="codeParam" type="text" value="code">
  </label>
  <label>가격 키 경로(JSON)
    <input id="priceKey" type="text" value="price" placeholder="예: data.price">
  </label>
  <label>풀링(초)
    <input id="pollSec" type="number" min="2" step="1" value="10">
  </label>
  <label><input type="checkbox" id="liveToggle" checked> 실시간 ON</label>
  <button id="addRowBtn">+ 종목 추가</button>
  <button id="saveBtn">저장</button>
  <button id="testBtn">현재가 테스트</button>
  <span id="status" class="status">상태: 대기</span>
</div>

<table id="grid">
  <thead>
    <tr>
      <th>코드</th>
      <th>이름</th>
      <th>평단가</th>
      <th>주수</th>
      <th>투입금액</th>
      <th>현재가</th>
      <th>고정가</th>
      <th>손익(원)</th>
      <th>손익(%)</th>
      <th>삭제</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
<div class="tot">
  <span class="mini">총 손익:</span>
  <span id="totalProfit" class="profit-neg">0</span>
</div>

<script>
const $ = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt = (n)=> (n??0).toLocaleString('ko-KR');
const toNum = (v)=>{ if(v===''||v==null) return 0; if(typeof v==='number') return v; return Number(String(v).replace(/,/g,''))||0; };
const calcProfit = (avg, cur, fix, qty)=>{ const base = (fix && !isNaN(fix) && fix!==0) ? fix : cur; if(!avg || !qty || !base) return {won:0, pct:0}; const won = (base-avg)*qty; const pct = ((base-avg)/avg)*100; return {won, pct}; };

const KEY_V3='stock_dashboard_rows_compact_v3';
const KEY_SETTINGS='stock_dashboard_settings_compact_v3';
function loadRows(){ try{ return JSON.parse(localStorage.getItem(KEY_V3)) || []; }catch{return []} }
function saveRows(r){ localStorage.setItem(KEY_V3, JSON.stringify(r)); }

let rows = loadRows();

function render(){
  const tb = $('#tbody'); tb.innerHTML='';
  rows.forEach(r=>{ r.invest = Math.round((r.avg||0)*(r.qty||0)); });
  rows.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td class="num"><input class="avg" value="${r.avg?fmt(r.avg):''}"></td>
      <td class="num"><input class="qty" value="${r.qty||''}"></td>
      <td class="num"><input class="invest" readonly value="${r.invest?fmt(r.invest):'0'}"></td>
      <td class="num"><input class="cur" value="${r.cur?fmt(r.cur):''}"></td>
      <td class="num"><input class="fix" value="${r.fix?fmt(r.fix):''}"></td>
      <td class="num"><span class="profit-won">0</span></td>
      <td class="num"><span class="profit-pct">0.00%</span></td>
      <td><button class="del">삭제</button></td>
    `;
    tb.appendChild(tr);
    tr.querySelector('.del').addEventListener('click',()=>{ rows.splice(idx,1); saveRows(rows); render(); });
    $$('input',tr).forEach(inp=>{
      inp.addEventListener('input',()=>applyRowEdit(idx,tr,true));
      inp.addEventListener('blur',()=>applyRowEdit(idx,tr,false));
      inp.addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();inp.blur();}});
    });
  });
  updateProfits();
}

function applyRowEdit(i, tr, live){
  const r = rows[i];
  const get = (sel)=> tr.querySelector(sel)?.value ?? '';
  const toN = (v)=>toNum(v);
  r.code = get('.code').trim();
  r.name = get('.name').trim();
  r.avg = toN(get('.avg'));
  r.qty = toN(get('.qty'));
  r.cur = toN(get('.cur'));
  r.fix = toN(get('.fix'));
  r.invest = Math.round((r.avg||0)*(r.qty||0));
  tr.querySelector('.invest').value = fmt(r.invest||0);
  if(!live){ tr.querySelector('.avg').value = r.avg?fmt(r.avg):''; tr.querySelector('.qty').value = r.qty?String(r.qty):''; tr.querySelector('.cur').value = r.cur?fmt(r.cur):''; tr.querySelector('.fix').value = r.fix?fmt(r.fix):''; }
  saveRows(rows);
  updateProfits();
}

function updateProfits(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r = rows[i];
    const {won,pct} = calcProfit(r.avg,r.cur,r.fix,r.qty);
    total += won;
    const w = tr.querySelector('.profit-won');
    w.textContent = fmt(Math.round(won));
    w.className = 'profit-won ' + (won>=0?'profit-pos':'profit-neg');
    const p = tr.querySelector('.profit-pct');
    p.textContent = (isFinite(pct)?pct.toFixed(2):'0.00')+'%';
  });
  const t=$('#totalProfit');
  t.textContent = fmt(Math.round(total));
  t.className = (total>=0)?'profit-pos':'profit-neg';
}

$('#addRowBtn').addEventListener('click',()=>{rows.push({code:'',name:'',avg:0,qty:0,cur:0,fix:0,invest:0});saveRows(rows);render();});
$('#saveBtn').addEventListener('click',()=>{saveRows(rows);alert('저장되었습니다.');});
$('#testBtn').addEventListener('click',()=>alert('테스트 완료'));

if(!rows.length){
  rows=[
    {code:'010620.KS',name:'삼성전자',avg:238000,qty:5,cur:224500,fix:0,invest:238000*5},
    {code:'015760.KS',name:'한국전력',avg:43150,qty:51,cur:45200,fix:0,invest:43150*51},
    {code:'000660.KS',name:'SK하이닉스',avg:0,qty:0,cur:589500,fix:0,invest:0}
  ];
  saveRows(rows);
}
render();
</script>
</body>
</html>
