<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>간단 포트 감시 (프록시 연동)</title>
  <style>
    :root { --fg:#111; --muted:#666; --red:#c62828; --green:#2e7d32; --bg:#fafafa; --line:#e5e7eb; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.25 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial;}
    .wrap{max-width:1200px;margin:16px auto;padding:0 12px;}
    .row{display:grid;grid-template-columns:220px 120px 80px 120px 120px 120px 90px 120px 60px;gap:8px;align-items:center;padding:6px 8px;border-bottom:1px solid var(--line);}
    .hdr{font-weight:700;background:#fff;position:sticky;top:0;z-index:1;border-top:1px solid var(--line);}
    .cell{display:flex;align-items:center;gap:6px;}
    input[type="text"],input[type="number"]{width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;background:#fff;outline:none;}
    input:focus{border-color:#9ca3af;box-shadow:0 0 0 2px rgba(59,130,246,.15);}
    .btn{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:6px;cursor:pointer;}
    .btn:hover{background:#f5f5f5;}
    .muted{color:var(--muted);font-size:12px;}
    .red{color:var(--red);} .green{color:var(--green);}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
    .small *{font-size:12px !important;} .tight .row{padding:3px 6px;} .tight input{padding:4px 6px;}
    .sum{font-weight:700;}
    .nameko{font-weight:600;} .nameen{font-size:12px;color:var(--muted);}
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <span class="muted">프록시: <b id="proxyUrl">http://localhost:3000/api</b></span>
    <label>폴링(초):
      <input type="number" id="pollSec" min="5" step="1" value="10" style="width:70px">
    </label>
    <button class="btn" id="toggleRun">실시간 ON</button>
    <button class="btn" id="addRow">+ 종목 추가</button>
    <label class="muted"><input type="checkbox" id="compact"> 밀집 모드</label>
    <span class="muted">임계치: +30,000 / -10,000 도달 시 알림</span>
  </div>

  <div class="row hdr">
    <div>종목(코드/이름)</div>
    <div>평단가</div>
    <div>주수</div>
    <div>투입금액</div>
    <div>현재가/고정가</div>
    <div>손익(원, 수수료 포함)</div>
    <div>손익(%)</div>
    <div class="sum">총 손익: <span id="sumPnl" class="red">0</span></div>
    <div></div>
  </div>
  <div id="rows"></div>
  <div class="muted">* 데이터는 브라우저 로컬스토리지에만 저장됩니다. 이름 줄(회색 텍스트)을 클릭하면 직접 편집(Enter/Blur 시 저장)됩니다.</div>
</div>

<script>
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> Array.from(el.querySelectorAll(sel));

const PROXY_BASE = localStorage.getItem('proxy_base') || 'http://localhost:3000/api';
$('#proxyUrl').textContent = PROXY_BASE;

function fmtKRW(n){ return new Intl.NumberFormat('ko-KR').format(+n||0); }
function pct(a,b){ if(!b) return 0; return ((a-b)/b*100); }
function ensureKSQ(s){ s = (s||'').toUpperCase().trim(); if(!s) return ''; if(/^\\d{6}$/.test(s)) return s+'.KS'; return s; }
function codeOf(s){ const m = String(s||'').match(/(\\d{6})/); return m? m[1] : ''; }

// 수수료 설정: 매수 0.26% + 매도 0.26% = 총 0.52%
const FEE_RATE = 0.0026; // 0.26
const FEE_TOTAL = FEE_RATE * 2; // 왕복

const DEFAULT = [{symbol:'005930.KS', avg:70000, shares:1, fix:null, name_ko:'', name_en:''}];
let rows = JSON.parse(localStorage.getItem('rows_v2')||'null') || DEFAULT;
let running = true;
let pollSec = +localStorage.getItem('poll_sec') || 10;
let notified = {};

$('#pollSec').value = pollSec;
$('#compact').checked = localStorage.getItem('compact')==='1';
if($('#compact').checked){ document.body.classList.add('small','tight'); }
$('#compact').onchange = (e)=>{
  if(e.target.checked){ document.body.classList.add('small','tight'); localStorage.setItem('compact','1'); }
  else { document.body.classList.remove('small','tight'); localStorage.removeItem('compact'); }
};

$('#toggleRun').onclick = ()=>{ running=!running; $('#toggleRun').textContent = running? '실시간 ON':'실시간 OFF'; if(running) kick(); };
$('#pollSec').onchange = (e)=>{ pollSec = Math.max(5, +e.target.value||10); localStorage.setItem('poll_sec', pollSec); kick(); };

function save(){ localStorage.setItem('rows_v2', JSON.stringify(rows)); }

function addRow(r){ rows.push(r||{symbol:'', avg:0, shares:0, fix:null, name_ko:'', name_en:''}); render(); save(); }
$('#addRow').onclick = ()=> addRow();

function delRow(i){ rows.splice(i,1); render(); save(); }
function move(i, dir){ const j = i+dir; if(j<0||j>=rows.length) return; const t = rows[i]; rows[i]=rows[j]; rows[j]=t; render(); save(); }

function setName(i, ko, en){ rows[i].name_ko = ko||''; rows[i].name_en=en||''; }

function rowView(r,i){
  const el = document.createElement('div');
  el.className = 'row';
  el.innerHTML = `
    <div class="cell">
      <input type="text" value="${r.symbol||''}" placeholder="예: 005930 또는 005930.KS" data-k="symbol">
      <div class="muted" title="한글/영문명 편집 가능" data-k="nameLine">
        <span class="nameko">${r.name_ko||''}</span> <span class="nameen">${r.name_en?'/ '+r.name_en:''}</span>
      </div>
    </div>
    <div><input type="number" value="${r.avg||''}" step="1" data-k="avg"></div>
    <div><input type="number" value="${r.shares||''}" step="1" data-k="shares"></div>
    <div class="muted" data-k="invest">-</div>
    <div><input type="number" value="${r.fix??''}" step="1" placeholder="(빈칸=실시간)" data-k="fix"></div>
    <div data-k="pnl" class="muted">-</div>
    <div data-k="pnlp" class="muted">-</div>
    <div class="cell">
      <button class="btn" data-act="up">▲</button>
      <button class="btn" data-act="down">▼</button>
    </div>
    <div><button class="btn" data-act="del">삭제</button></div>
  `;
  // bind
  $$('input', el).forEach(inp=>{
    inp.addEventListener('change', (e)=>{
      const k = inp.dataset.k;
      let v = inp.value;
      if(k==='symbol'){ v = ensureKSQ(v); rows[i][k]=v; fetchQuotes(); }
      else if(k==='avg'||k==='shares'||k==='fix'){ rows[i][k]= v===''? null : Number(v); }
      save(); renderCalc();
    });
  });
  // editable name line
  const nameLine = $('[data-k="nameLine"]', el);
  nameLine.addEventListener('click', ()=>{
    const cur = (rows[i].name_ko||'') + (rows[i].name_en?(' / '+rows[i].name_en):'');
    const nv = prompt('한글명 / 영문명 순서로 입력', cur);
    if(nv!=null){
      const [ko,en] = nv.split('/').map(s=>s?.trim());
      setName(i, ko||'', en||'');
      save(); render();
    }
  });

  // actions
  el.addEventListener('click', (e)=>{
    const act = e.target.dataset.act;
    if(act==='del') delRow(i);
    if(act==='up') move(i,-1);
    if(act==='down') move(i,1);
  });
  return el;
}

function render(){
  const box = $('#rows'); box.innerHTML='';
  rows.forEach((r,i)=> box.appendChild(rowView(r,i)) );
  $('#toggleRun').textContent = running? '실시간 ON':'실시간 OFF';
  renderCalc();
}

function renderCalc(quotes={}){
  let total = 0;
  rows.forEach((r,i)=>{
    const el = $$('.row', $('#rows'))[i];
    const invest = (r.avg||0) * (r.shares||0);
    $('[data-k="invest"]', el).textContent = fmtKRW(invest);
    const q = quotes[r.symbol]?.c || 0;
    const cur = r.fix!=null && r.fix!=='' ? Number(r.fix) : q;

    // 수수료 반영 (왕복 0.52%): 매수 기준금액 * 0.52% 를 고정 비용으로 차감
    const fee = invest * FEE_TOTAL;

    const grossPnl = (cur - (r.avg||0)) * (r.shares||0);
    const pnl = grossPnl - fee;
    const pnltxt = (pnl>=0? '+' : '') + fmtKRW(pnl);

    // 손익률은 (수익/투입) 기준으로 수수료 반영
    const pnlp = invest ? ((cur - (r.avg||0)) / (r.avg||0) * 100) - (FEE_TOTAL * 100) : 0;
    const pnpp = isFinite(pnlp)? pnlp.toFixed(2)+'%' : '-';

    const pnlEl = $('[data-k="pnl"]', el);
    const pnlpEl = $('[data-k="pnlp"]', el);
    pnlEl.textContent = pnltxt;
    pnlEl.className = pnl>=0?'green':'red';
    pnlpEl.textContent = pnpp;
    pnlpEl.className = pnl>=0?'green':'red';
    total += pnl;

    notifyIfNeeded(r.symbol, pnl);
  });
  $('#sumPnl').textContent = fmtKRW(total);
  $('#sumPnl').className = total>=0?'green':'red';
}

function notifyIfNeeded(sym, pnl){
  const up = 30000, down = -10000;
  const st = notified[sym] || null;
  if(pnl>=up && st!=='up'){ fire(`[상승] ${sym}`, `손익 +${fmtKRW(pnl)}`); notified[sym]='up'; }
  else if(pnl<=down && st!=='down'){ fire(`[하락] ${sym}`, `손익 ${fmtKRW(pnl)}`); notified[sym]='down'; }
  else if(pnl<up && pnl>down && st){ notified[sym]=null; }
}

function fire(title, body){
  try{
    if(!('Notification' in window)) return;
    if(Notification.permission==='granted') new Notification(title, { body });
    else if(Notification.permission!=='denied') Notification.requestPermission();
  }catch(e){}
}

async function fetchQuotes(){
  const syms = rows.map(r=>ensureKSQ(r.symbol)).filter(Boolean);
  if(syms.length===0) return renderCalc({});
  const url = `${PROXY_BASE}/quote?symbols=${encodeURIComponent(syms.join(','))}`;
  const res = await fetch(url);
  if(!res.ok){ console.error('proxy error', res.status); return; }
  const j = await res.json();
  rows.forEach((r,i)=>{
    const q = j[r.symbol]; if(!q) return;
    if(!r.name_ko && q.name){ r.name_ko = q.name; }
  });
  save();
  renderCalc(j);
}

let timer=null;
function kick(){
  if(timer) clearInterval(timer);
  if(!running) return;
  fetchQuotes();
  timer = setInterval(fetchQuotes, Math.max(5, pollSec)*1000);
}

render();
kick();
</script>
</body>
</html>
