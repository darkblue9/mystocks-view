<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 (v3.1 · 고정가/현재가 분리)</title>
<style>
  :root{
    --border:#e5e7eb; --muted:#6b7280; --ok:#059669; --bad:#ef4444;
  }
  html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 12px}
  .box{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px 12px}
  .mini{font-size:12px;color:var(--muted)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
  .pill{border:1px solid var(--border);border-radius:999px;padding:2px 8px}
  input[type="text"],input[type="number"]{width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:14px}
  input[readonly]{background:#f9fafb}
  button{border:1px solid var(--border);border-radius:8px;padding:6px 10px;background:#fff;cursor:pointer}
  button.primary{background:#2563eb;border-color:#2563eb;color:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
  thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);padding:8px 6px}
  tbody td{border-bottom:1px solid var(--border);padding:6px}
  td,th{text-align:center;vertical-align:middle}
  .num{text-align:right}
  .w-code{width:110px}
  .w-name{width:170px}
  .w-qty{width:70px}
  .w-amt{width:120px}
  .w-price{width:110px}
  .profit-pos{color:var(--ok);font-weight:700}
  .profit-neg{color:var(--bad);font-weight:700}
  .totals{display:flex;justify-content:flex-end;gap:8px;margin-top:10px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="controls box">
    <span class="mini">프록시: <span id="apiBase" class="pill">http://localhost:3000/api</span></span>
    <label class="mini"><input type="checkbox" id="liveToggle" checked> 실시간 ON</label>
    <label class="mini">풀링(초): <input id="pollSec" type="number" min="2" step="1" value="10" style="width:70px"></label>
    <button id="addRowBtn" class="primary">+ 종목 추가</button>
    <button id="saveBtn">저장</button>
    <span class="mini">* 입력 후 Enter/탭 또는 포커스 아웃 시 저장됩니다.</span>
  </div>

  <div class="box">
    <table id="grid">
      <thead>
        <tr>
          <th class="w-code">코드</th>
          <th class="w-name">이름</th>
          <th class="w-price">평단가</th>
          <th class="w-qty">주수</th>
          <th class="w-amt">투입금액</th>
          <th class="w-price">현재가</th>
          <th class="w-price">고정가</th>
          <th class="w-amt">손익(원)</th>
          <th class="w-price">손익(%)</th>
          <th style="width:70px">삭제</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="totals">
      <span class="mini">총 손익:</span>
      <span id="totalProfit" class="profit-neg">0</span>
    </div>
  </div>
</div>

<script>
// ===== 유틸 =====
const $ = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt = (n)=> (n??0).toLocaleString('ko-KR');
const toNum = (v)=>{
  if(v===''||v==null) return 0;
  if(typeof v==='number') return v;
  return Number(String(v).replace(/,/g,''))||0;
};
const calcProfit = (avg, cur, fix, qty)=>{
  const base = (fix && !isNaN(fix) && fix!==0) ? fix : cur;
  if(!avg || !qty || !base) return {won:0, pct:0};
  const won = (base-avg)*qty;
  const pct = ((base-avg)/avg)*100;
  return {won, pct};
};

// ===== 저장 키 & 마이그레이션 =====
const KEY_V3='stock_dashboard_rows_v3';
const LEGACY_KEYS=['stock_dashboard_rows_v2','stock_rows','rows','stock_dashboard_rows'];
function loadRows(){
  // v3 우선
  let r=null;
  try{ r = JSON.parse(localStorage.getItem(KEY_V3)); }catch{}
  if(Array.isArray(r) && r.length) return r;

  // 레거시 스캔
  for(const k of LEGACY_KEYS){
    try{
      const v = JSON.parse(localStorage.getItem(k));
      if(Array.isArray(v) && v.length){
        // 필드 매핑 최소화
        const m = v.map(x=>({
          code: x.code||x.symbol||'',
          name: x.name||x.title||'',
          avg:  toNum(x.avg||x.avgPrice||x.buy||0),
          qty:  toNum(x.qty||x.quantity||x.shares||0),
          cur:  toNum(x.cur||x.price||0),
          fix:  toNum(x.fix||x.fixed||0),
          invest: 0 // 아래에서 재계산
        }));
        m.forEach(o=> o.invest = Math.round((o.avg||0)*(o.qty||0)));
        localStorage.setItem(KEY_V3, JSON.stringify(m));
        return m;
      }
    }catch{}
  }
  return [];
}
function saveRows(r){ localStorage.setItem(KEY_V3, JSON.stringify(r)); }

// ===== 상태 =====
let rows = loadRows();
let timer=null;

// ===== 렌더 =====
function render(){
  const tb = $('#tbody');
  tb.innerHTML='';
  // 투자금/손익 즉시 계산 보장
  rows.forEach(r=>{ r.invest = Math.round((r.avg||0)*(r.qty||0)); });
  rows.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="w-code"><input class="cell code" value="${r.code||''}"></td>
      <td class="w-name"><input class="cell name" value="${r.name||''}"></td>
      <td class="w-price num"><input class="cell avg num" placeholder="0" value="${r.avg?fmt(r.avg):''}"></td>
      <td class="w-qty num"><input class="cell qty num" placeholder="0" value="${r.qty||''}"></td>
      <td class="w-amt num"><input class="cell invest num" readonly value="${r.invest?fmt(r.invest):'0'}"></td>
      <td class="w-price num"><input class="cell cur num" placeholder="(실시간)" ${($('#liveToggle').checked?'readonly':'')} value="${r.cur?fmt(r.cur):''}"></td>
      <td class="w-price num"><input class="cell fix num" placeholder="고정가" value="${r.fix?fmt(r.fix):''}"></td>
      <td class="w-amt num"><span class="profit-won">0</span></td>
      <td class="w-price num"><span class="profit-pct">0.00%</span></td>
      <td><button class="danger del">삭제</button></td>
    `;
    tb.appendChild(tr);

    // 삭제
    tr.querySelector('.del').addEventListener('click',()=>{
      rows.splice(idx,1); saveRows(rows); render();
    });

    // 입력 실시간 반영 + blur 포맷
    const onChange=()=>applyRowEdit(idx,tr,true);
    const onCommit=(e)=>{ if(e) e.preventDefault(); applyRowEdit(idx,tr,false); };
    $$('input.cell',tr).forEach(inp=>{
      inp.addEventListener('input', onChange);
      inp.addEventListener('blur', onCommit);
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); } });
    });
  });
  updateProfits();
}

// ===== 입력 반영 =====
function applyRowEdit(i, tr, live){
  const r = rows[i];
  const get = (sel)=> tr.querySelector(sel)?.value ?? '';
  r.code = get('.code').trim();
  r.name = get('.name').trim();
  // live=true일 때는 포맷 미적용 숫자만 갱신
  r.avg = toNum(get('.avg'));
  r.qty = toNum(get('.qty'));
  r.cur = toNum(get('.cur'));
  r.fix = toNum(get('.fix'));
  r.invest = Math.round((r.avg||0)*(r.qty||0));
  tr.querySelector('.invest').value = fmt(r.invest||0);
  if(!live){ // commit 시 포맷 적용
    tr.querySelector('.avg').value = r.avg?fmt(r.avg):'';
    tr.querySelector('.qty').value = r.qty?String(r.qty):'';
    tr.querySelector('.cur').value = r.cur?fmt(r.cur):'';
    tr.querySelector('.fix').value = r.fix?fmt(r.fix):'';
  }
  saveRows(rows);
  updateProfits();
}

// ===== 손익/합계 =====
function updateProfits(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r = rows[i];
    const {won,pct} = calcProfit(r.avg,r.cur,r.fix,r.qty);
    total += won;
    const w = tr.querySelector('.profit-won');
    w.textContent = fmt(Math.round(won));
    w.className = 'profit-won ' + (won>=0?'profit-pos':'profit-neg');
    tr.querySelector('.profit-pct').textContent = (isFinite(pct)?pct.toFixed(2):'0.00')+'%';
  });
  const t=$('#totalProfit');
  t.textContent = fmt(Math.round(total));
  t.className = (total>=0)?'profit-pos':'profit-neg';
}

// ===== 실시간 폴링 =====
async function fetchPrices(codes){
  const base = $('#apiBase').textContent.trim();
  const q = encodeURIComponent(codes.join(','));
  const url = `${base}/prices?codes=${q}`;
  try{
    const res = await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j = await res.json();
    (j.data||[]).forEach(p=>{
      const idx = rows.findIndex(r=>r.code===p.code);
      if(idx>=0){ rows[idx].cur = Number(p.price)||rows[idx].cur||0; }
    });
    saveRows(rows);
    $$('#tbody tr').forEach((tr,i)=> tr.querySelector('.cur').value = rows[i].cur?fmt(rows[i].cur):'');
    updateProfits();
  }catch(e){ console.warn('가격 조회 실패', e); }
}
function tick(){
  if(!$('#liveToggle').checked) return;
  const codes = rows.map(r=>r.code).filter(Boolean);
  if(!codes.length) return;
  fetchPrices(codes);
}
function startPolling(){
  stopPolling();
  if(!$('#liveToggle').checked) return;
  const sec = Math.max(2, Number($('#pollSec').value)||10);
  timer = setInterval(tick, sec*1000);
  tick();
}
function stopPolling(){ if(timer){clearInterval(timer); timer=null;} }

// ===== 초기 =====
$('#addRowBtn').addEventListener('click', ()=>{
  rows.push({code:'',name:'',avg:0,qty:0,cur:0,fix:0,invest:0});
  saveRows(rows); render();
});
$('#saveBtn').addEventListener('click', ()=>{ saveRows(rows); alert('저장되었습니다.'); });
$('#liveToggle').addEventListener('change', ()=>{
  $$('#tbody .cur').forEach(inp=> inp.readOnly = $('#liveToggle').checked);
  if($('#liveToggle').checked) startPolling(); else stopPolling();
});
$('#pollSec').addEventListener('change', startPolling);

// 최초 데이터 보정(샘플/레거시)
if(!rows.length){
  rows = [
    {code:'010620.KS', name:'삼성전자', avg:238000, qty:5, cur:0, fix:0, invest:238000*5},
    {code:'015760.KS', name:'한국전력', avg:43150,  qty:51, cur:0, fix:0, invest:43150*51},
    {code:'000660.KS', name:'SK하이닉스', avg:0, qty:0, cur:0, fix:0, invest:0},
  ];
  saveRows(rows);
}
render();
startPolling();
</script>
</body>
</html>
