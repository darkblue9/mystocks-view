<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>포트 감시 (v3.4h compact + 수수료 0.26%)</title>
<style>
:root { --fg:#111; --muted:#666; --red:#c62828; --green:#2e7d32; --bg:#fafafa; --line:#e5e7eb; }
html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.25 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial;}
.wrap{max-width:1200px;margin:16px auto;padding:0 12px;}
.row{display:grid;grid-template-columns:220px 120px 80px 120px 120px 120px 90px 120px 60px;gap:8px;align-items:center;padding:6px 8px;border-bottom:1px solid var(--line);}
.hdr{font-weight:700;background:#fff;position:sticky;top:0;z-index:1;border-top:1px solid var(--line);}
.cell{display:flex;align-items:center;gap:6px;}
input[type="text"],input[type="number"]{width:100%;padding:6px 8px;border:1px solid var(--line);border-radius:6px;background:#fff;outline:none;}
input:focus{border-color:#9ca3af;box-shadow:0 0 0 2px rgba(59,130,246,.15);}
.btn{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:6px;cursor:pointer;}
.btn:hover{background:#f5f5f5;}
.muted{color:var(--muted);font-size:12px;}
.red{color:var(--red);} .green{color:var(--green);}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
.small *{font-size:12px !important;} .tight .row{padding:3px 6px;} .tight input{padding:4px 6px;}
.sum{font-weight:700;}
.nameko{font-weight:600;} .nameen{font-size:12px;color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
<div class="toolbar">
<span class="muted">프록시: <b id="proxyUrl">http://localhost:3000/api</b></span>
<label>폴링(초): <input type="number" id="pollSec" min="5" step="1" value="10" style="width:70px"></label>
<button class="btn" id="toggleRun">실시간 ON</button>
<button class="btn" id="addRow">+ 종목 추가</button>
<label class="muted"><input type="checkbox" id="compact"> 밀집 모드</label>
<span class="muted">임계치: +30,000 / -10,000 도달 시 알림</span>
</div>
<div class="row hdr">
<div>종목(코드/이름)</div>
<div>평단가</div>
<div>주수</div>
<div>투입금액</div>
<div>현재가/고정가</div>
<div>손익(원, 수수료 0.26%)</div>
<div>손익(%)</div>
<div class="sum">총 손익: <span id="sumPnl" class="red">0</span></div>
<div></div>
</div>
<div id="rows"></div>
<div class="muted">* 수수료 0.26%(매수 0.015% + 매도 0.015% + 거래세 0.23%) 반영됨.</div>
</div>

<script>
const $=(s,e=document)=>e.querySelector(s);const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
const PROXY_BASE='http://localhost:3000/api';
function fmtKRW(n){return new Intl.NumberFormat('ko-KR').format(+n||0);}
function ensureKSQ(s){s=(s||'').toUpperCase().trim();if(!s)return'';if(/^\d{6}$/.test(s))return s+'.KS';return s;}
const FEE_BUY=0.00015,FEE_SELL=0.00015,FEE_TAX=0.0023;
let rows=JSON.parse(localStorage.getItem('rows_v3')||'[]');
if(!rows.length)rows=[{symbol:'005930.KS',avg:70000,shares:1,fix:null,name_ko:'',name_en:''}];
let running=true,timer=null;let pollSec=10;let notified={};
function save(){localStorage.setItem('rows_v3',JSON.stringify(rows));}
function addRow(){rows.push({symbol:'',avg:0,shares:0,fix:null,name_ko:'',name_en:''});render();save();}
function delRow(i){rows.splice(i,1);render();save();}
function move(i,d){let j=i+d;if(j<0||j>=rows.length)return;[rows[i],rows[j]]=[rows[j],rows[i]];render();save();}
function setName(i,ko,en){rows[i].name_ko=ko||'';rows[i].name_en=en||'';}
function render(){const box=$('#rows');box.innerHTML='';rows.forEach((r,i)=>box.appendChild(rowView(r,i)));renderCalc();}
function rowView(r,i){const el=document.createElement('div');el.className='row';
el.innerHTML=`
<div class="cell"><input type="text" value="${r.symbol||''}" data-k="symbol"><div class="muted" data-k="nameLine"><span class="nameko">${r.name_ko||''}</span> <span class="nameen">${r.name_en?'/ '+r.name_en:''}</span></div></div>
<div><input type="number" value="${r.avg||''}" data-k="avg"></div>
<div><input type="number" value="${r.shares||''}" data-k="shares"></div>
<div class="muted" data-k="invest">-</div>
<div><input type="number" value="${r.fix??''}" placeholder="(빈칸=실시간)" data-k="fix"></div>
<div data-k="pnl" class="muted">-</div>
<div data-k="pnlp" class="muted">-</div>
<div class="cell"><button class="btn" data-act="up">▲</button><button class="btn" data-act="down">▼</button></div>
<div><button class="btn" data-act="del">삭제</button></div>`;
$$('input',el).forEach(inp=>inp.addEventListener('change',()=>{
const k=inp.dataset.k,v=inp.value;if(k==='symbol'){rows[i][k]=ensureKSQ(v);fetchQuotes();}
else if(k==='avg'||k==='shares'||k==='fix'){rows[i][k]=v===''?null:Number(v);}save();renderCalc();}));
const nameLine=$('[data-k="nameLine"]',el);
nameLine.onclick=()=>{const cur=(r.name_ko||'')+(r.name_en?(' / '+r.name_en):'');const nv=prompt('한글명 / 영문명',cur);if(nv!=null){const[ko,en]=nv.split('/').map(s=>s?.trim());setName(i,ko,en);save();render();}};
el.onclick=e=>{const a=e.target.dataset.act;if(a==='del')delRow(i);if(a==='up')move(i,-1);if(a==='down')move(i,1);};
return el;}
function renderCalc(q={}){let total=0;rows.forEach((r,i)=>{const el=$$('.row',$('#rows'))[i];const invest=(r.avg||0)*(r.shares||0);$('[data-k="invest"]',el).textContent=fmtKRW(invest);const live=q[r.symbol]?.c||0;const cur=(r.fix!==null&&r.fix!==''?Number(r.fix):live);
const buyVal=invest,sellVal=cur*(r.shares||0);
const feeBuy=buyVal*FEE_BUY,feeSell=sellVal*FEE_SELL,feeTax=sellVal*FEE_TAX;const feeAll=feeBuy+feeSell+feeTax;
const pnl=(sellVal-buyVal)-feeAll;const pnlPct=invest?(pnl/invest*100):0;
const pnlEl=$('[data-k="pnl"]',el),pnlpEl=$('[data-k="pnlp"]',el);
pnlEl.textContent=(pnl>=0?'+':'')+fmtKRW(pnl);pnlEl.className=pnl>=0?'green':'red';
pnlpEl.textContent=isFinite(pnlPct)?pnlPct.toFixed(2)+'%':'-';pnlpEl.className=pnl>=0?'green':'red';
total+=pnl;notifyIfNeeded(r.symbol,pnl);});
$('#sumPnl').textContent=fmtKRW(total);$('#sumPnl').className=total>=0?'green':'red';}
function notifyIfNeeded(sym,pnl){const up=30000,down=-10000;const st=notified[sym]||null;
if(pnl>=up&&st!=='up'){fire(`[상승] ${sym}`,`손익 +${fmtKRW(pnl)}`);notified[sym]='up';}
else if(pnl<=down&&st!=='down'){fire(`[하락] ${sym}`,`손익 ${fmtKRW(pnl)}`);notified[sym]='down';}
else if(pnl<up&&pnl>down&&st){notified[sym]=null;}}
function fire(t,b){try{if(!('Notification'in window))return;if(Notification.permission==='granted')new Notification(t,{body:b});else if(Notification.permission!=='denied')Notification.requestPermission();}catch(e){}}
async function fetchQuotes(){const syms=rows.map(r=>ensureKSQ(r.symbol)).filter(Boolean);if(!syms.length)return renderCalc({});
const res=await fetch(`${PROXY_BASE}/quote?symbols=${encodeURIComponent(syms.join(','))}`);
if(!res.ok)return;const j=await res.json();rows.forEach(r=>{const q=j[r.symbol];if(!r.name_ko&&q?.name)r.name_ko=q.name;});save();renderCalc(j);}
function kick(){if(timer)clearInterval(timer);if(!running)return;fetchQuotes();timer=setInterval(fetchQuotes,pollSec*1000);}
render();kick();
</script>
</body>
</html>