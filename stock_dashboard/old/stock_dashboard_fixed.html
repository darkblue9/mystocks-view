<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 v3.4h (미니멀 · 12px · 버튼 가로정렬 · Null-Guard)</title>
<style>
body{font-family:sans-serif;margin:10px;font-size:12px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px}
th,td{border:1px solid #ccc;padding:2px;text-align:center}
input,select,button{font:inherit;font-size:12px}
td input{width:60%;text-align:right}
td input[readonly]{background:#f9f9f9}
.mv{display:inline-flex;gap:2px;vertical-align:middle}
.mv button{width:20px;height:20px;font-size:10px;padding:0;margin:0}
.del{margin-left:4px;height:22px;font-size:11px}
.status{font-size:10px}
.profit-pos{color:green}
.profit-neg{color:red}
</style>
</head>
<body>
<div>
  <label>프록시 <input id="apiBase" value="http://localhost:3000" style="width:120px"></label>
  <label>엔드포인트 <select id="apiMode"><option value="auto">자동</option><option value="multi">멀티</option><option value="single">단건</option></select></label>
  <label>코드파라미터<input id="codeParam" value="code" style="width:60px"></label>
  <label>가격키<input id="priceKey" value="price" style="width:60px"></label>
  <label>풀링(초)<input id="pollSec" type="number" value="10" min="2" style="width:40px"></label>
  <label><input type="checkbox" id="liveToggle" checked>실시간</label>
  <button id="addRowBtn">+추가</button>
  <button id="saveBtn">저장</button>
  <button id="testBtn">테스트</button>
  <span id="status" class="status">상태: 대기</span>
</div>
<table id="grid">
  <thead><tr>
    <th>코드</th><th>이름</th><th>평단가</th><th>주수</th><th>투입금액</th>
    <th>현재가</th><th>고정가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div>총 손익: <span id="totalProfit" class="profit-neg">0</span> (수수료 0.26%)</div>

<script>
const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));
const fmt=n=>(n??0).toLocaleString('ko-KR');const toNum=v=>Number(String(v||'').replace(/,/g,''))||0;
const FEE_BUY=0.00015,FEE_SELL=0.00015,TAX_SELL=0.00230;
function calc(avg,cur,fix,qty){const b=(fix&&fix!==0)?fix:cur;if(!avg||!qty||!b)return{won:0,pct:0};
const buy=avg*qty,sell=b*qty;const fee=buy*FEE_BUY+sell*(FEE_SELL+TAX_SELL);const p=sell-buy-fee;return{won:p,pct:(p/buy*100)};}
const KEY='rows_v34h_mini_12px_guard';

function load(){try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]}}
function save(){localStorage.setItem(KEY,JSON.stringify(rows))}
let rows=load();

function render(){
  const tb=$('#tbody');tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td><input class="avg" value="${r.avg||''}"></td>
      <td><input class="qty" value="${r.qty||''}"></td>
      <td><input class="inv" readonly></td>
      <td><input class="cur" value="${r.cur||''}"></td>
      <td><input class="fix" value="${r.fix||''}"></td>
      <td class="num"><span class="pw">0</span></td>
      <td class="num"><span class="pp">0%</span></td>
      <td>
        <span class="mv"><button class="up">▲</button><button class="down">▼</button></span>
        <button class="del">삭제</button>
      </td>`;
    tb.appendChild(tr);

    // 이벤트 바인딩
    tr.querySelector('.del').onclick=()=>{rows.splice(i,1);save();render();};
    tr.querySelector('.up').onclick=()=>{if(i>0){[rows[i-1],rows[i]]=[rows[i],rows[i-1]];save();render();}};
    tr.querySelector('.down').onclick=()=>{if(i<rows.length-1){[rows[i+1],rows[i]]=[rows[i],rows[i+1]];save();render();}};
    $$('.code,.name,.avg,.qty,.cur,.fix',tr).forEach(inp=>inp.oninput=()=>apply(i,tr));
  });
  update(); // 안전 가드 포함
}

function apply(i,tr){
  const r = rows[i] || (rows[i]={});
  const get = sel => (tr.querySelector(sel)?.value || '').trim();
  r.code = get('.code'); r.name = get('.name');
  r.avg = toNum(get('.avg')); r.qty = toNum(get('.qty'));
  r.cur = toNum(get('.cur')); r.fix = toNum(get('.fix'));
  r.inv = r.avg * r.qty;
  save();
  update();
}

function update(){
  let tot=0;
  const trs = $$('#tbody tr');
  trs.forEach((tr,i)=>{
    const r = rows[i] || {};
    r.inv = (r.avg||0) * (r.qty||0);
    const invEl = tr.querySelector('.inv'); if(invEl){ invEl.value = fmt(r.inv); }
    const {won,pct} = calc(r.avg, r.cur, r.fix, r.qty);
    tot += won;
    const pw = tr.querySelector('.pw'); if(pw){ pw.textContent = fmt(Math.round(won)); pw.className = 'pw ' + (won>=0?'profit-pos':'profit-neg'); }
    const pp = tr.querySelector('.pp'); if(pp){ pp.textContent = (isFinite(pct)?pct.toFixed(2):'0.00') + '%'; }
  });
  const t=$('#totalProfit'); if(t){ t.textContent = fmt(Math.round(tot)); t.className = (tot>=0)?'profit-pos':'profit-neg'; }
}

$('#addRowBtn').onclick=()=>{rows.push({});save();render();};
$('#saveBtn').onclick=()=>{save();alert('저장되었습니다.');};
$('#testBtn').onclick=()=>update();

// 초기 데이터(비어있으면 샘플)
if(!rows.length){
  rows=[
    {code:'000660.KS',name:'SK하이닉스',avg:586000,qty:4,cur:553000},
    {code:'009830',name:'한화솔루션',avg:33800,qty:80,cur:31400},
    {code:'000250',name:'삼천당제약',avg:241000,qty:5,cur:235500},
    {code:'100090',name:'SK오션플랜트',avg:21950,qty:115,cur:2524250}
  ];
  save();
}
render();
</script>
</body>
</html>
