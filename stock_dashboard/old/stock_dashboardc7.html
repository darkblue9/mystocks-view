<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stock Dashboard – clean</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{ --bd:#ddd; --ok:#0a7a0a; --bad:#c00; --blue:#1e5aff; --fz:14px; }
  html,body{margin:0;font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Malgun Gothic,sans-serif;font-size:var(--fz)}
  .bar{position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border-bottom:1px solid var(--bd)}
  .bar input[type="number"], .bar input[type="text"]{height:28px}
  .bar button{height:28px;padding:0 10px}
  .state{font-weight:700;margin-left:6px}
  .state.ok{color:var(--ok)} .state.bad{color:var(--bad)}
  .top-total{position:fixed;top:50px;right:12px;z-index:6;background:#fff;border:1px solid var(--bd);padding:4px 10px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,.08);font-weight:700}
  .total-pos{color:var(--ok)} .total-neg{color:var(--bad)}

  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid var(--bd);padding:6px 8px;text-align:center;vertical-align:middle;white-space:nowrap}
  th{background:#fafafa;position:sticky;top:44px;z-index:4}

  /* 열 폭 */
  col.col-code{width:90px}
  col.col-name{width:140px}
  col.col-avg{width:110px}
  col.col-qty{width:60px}              /* 주수 50% 축소 */
  col.col-inv{width:130px}
  col.col-ut{width:110px}
  col.col-lt{width:110px}
  col.col-cur{width:90px}              /* 현재가 셀 폭 30% 축소 (input 유지) */
  col.col-fix{width:90px}              /* 매도가 셀 폭 30% 축소 (input 유지) */
  col.col-profit{width:120px}          /* 손익(원) 15% 축소 */
  col.col-per{width:90px}              /* 손익(%) 15% 축소 */
  col.col-act{width:180px}

  td input[type="number"], td input[type="text"]{width:100%;height:28px;box-sizing:border-box}
  td input.readonly{background:#f7f7f7}

  /* 점멸 도트 */
  .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#aaa;margin-right:6px;vertical-align:middle;opacity:.25}
  .dot.up{background:#c44;animation:blink 1s linear infinite}    /* 상승=적 */
  .dot.down{background:#46f;animation:blink 1s linear infinite}  /* 하락=청 */
  @keyframes blink{0%,60%{opacity:.2}61%,100%{opacity:1}}

  /* 액션 버튼 */
  .actions{display:inline-flex;align-items:center;gap:6px}
  .mv{display:inline-flex;gap:4px}
  .mv button{height:22px;font-size:11px;padding:0 6px}
  .chart, .del{height:22px;font-size:11px;padding:0 8px}

  /* Δ 배지 (상승=적, 하락=청) */
  .delta-badges{display:inline-flex;gap:4px;margin-left:6px;font-size:11px}
  .delta-badge{border:1px solid #ccc;border-radius:8px;padding:0 6px;line-height:18px}
  .delta-pos{color:#c00;border-color:#c00}
  .delta-neg{color:#1e5aff;border-color:#1e5aff}

  .bottom-bar{display:flex;justify-content:flex-end;gap:8px;padding:8px 10px}

  /* 차트 모달 */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9}
  .modal.show{display:flex}
  .modal-card{background:#fff;border-radius:10px;min-width:320px;max-width:92vw;width:720px;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #eee}
  .modal-body{padding:10px}
  .modal-footer{padding:8px 12px;border-top:1px solid #eee;text-align:right}
</style>
</head>
<body>
  <div class="bar">
    <label>풀링(초) <input id="pollSec" type="number" min="1" step="1" value="10" style="width:72px"></label>
    <label><input id="live" type="checkbox" checked> 실시간</label>
    <button id="addBtn">+추가</button>
    <button id="saveBtn">저장</button>
    <button id="copyBtn">텍스트로 복사</button>
    <button id="testBtn">테스트</button>
    <label><input type="checkbox" id="trackToggle" checked> 변동추적</label>
    <button id="cloudSaveBtn">클라우드 저장</button>
    <button id="cloudLoadBtn">클라우드 불러오기</button>
    <span id="state" class="state">상태: 대기</span>
  </div>

  <div id="topTotal" class="top-total">총 손익: 0</div>

  <table id="grid">
    <colgroup>
      <col class="col-code"><col class="col-name"><col class="col-avg"><col class="col-qty">
      <col class="col-inv"><col class="col-ut"><col class="col-lt">
      <col class="col-cur"><col class="col-fix"><col class="col-profit"><col class="col-per"><col class="col-act">
    </colgroup>
    <thead>
      <tr>
        <th>코드</th><th>이름</th><th>매수가</th><th>주수</th><th>투입금액</th>
        <th>상목표</th><th>하목표</th><th>현재가</th><th>매도가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="bottom-bar"><button id="addBtnBottom">+추가</button></div>

  <div id="chartModal" class="modal">
    <div class="modal-card">
      <div class="modal-header"><strong id="chartTitle">차트</strong><button id="chartClose">닫기</button></div>
      <div class="modal-body"><canvas id="histChart" width="680" height="360"></canvas></div>
      <div class="modal-footer"><small>최근 24시간, 5분 간격 스냅샷</small></div>
    </div>
  </div>

<script>
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const LS='sd_rows_v2', LS_SET='sd_set_v2';
let rows = load(LS, []), settings = load(LS_SET, {});
function load(k, d){ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d));}catch(e){return d;} }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

function fmt(n){ if(n==null||isNaN(n)) return '0'; const sign=n>=0?'':'-'; const abs=Math.abs(Math.round(n)); return sign+abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g,','); }
function num(s){ if(s==null) return 0; return parseFloat(String(s).replace(/[^\d\.-]/g,''))||0; }
function ok(){return '#0a7a0a'}; function bad(){return '#c00'};

function normalizeCode(c){ return (c||'').trim(); }

/* ===== 5분 스냅샷 ===== */
const HIST='hist_v2::', slotOf=t=>Math.floor(t/(5*60*1000));
function hKey(code){ return HIST + (normalizeCode(code)||''); }
function hLoad(code){ try{return JSON.parse(localStorage.getItem(hKey(code))||'[]');}catch(e){return [];} }
function hSave(code, arr){
  const cut = Date.now()-24*60*60*1000;
  const t = arr.filter(x=>x && x.t && x.t>=cut);
  localStorage.setItem(hKey(code), JSON.stringify(t));
}
function addSnap(code, price){
  if(!code || !price) return;
  const now=Date.now(), arr=hLoad(code), last=arr[arr.length-1];
  if(last && slotOf(last.t)===slotOf(now)) return;
  arr.push({t:now,p:price}); if(arr.length>350) arr.splice(0, arr.length-300);
  hSave(code, arr);
}
function priceAt(code, msAgo){
  const target=Date.now()-msAgo, a=hLoad(code);
  for(let i=a.length-1;i>=0;i--){ if(a[i].t<=target) return a[i].p; } return null;
}
function deltasHTML(code, cur){
  const p5=priceAt(code,5*60*1000), p60=priceAt(code,60*60*1000);
  const d5=(p5!=null&&cur)?cur-p5:null, d60=(p60!=null&&cur)?cur-p60:null;
  const mk=(v,l)=>v==null?'':`<span class="delta-badge ${v>=0?'delta-pos':'delta-neg'}">${l}:${v>0?'+':''}${Math.round(v)}</span>`;
  return `<span class="delta-badges">${mk(d5,'Δ5m')}${mk(d60,'Δ1h')}</span>`;
}

function rowHTML(r,i){
  const avg=num(r.avg), qty=num(r.qty), cur=num(r.cur), fix=num(r.fix)||cur;
  const inv = Math.round(avg*qty);
  const profit = Math.round((fix-avg)*qty);
  const ratio = (avg>0)? ((fix-avg)/avg*100) : 0;

  const step = (cur>100000)?500:100;
  const upDot = (r.utarget && cur>=num(r.utarget));
  const dnDot = (r.ltarget && cur<=num(r.ltarget));

  return `<tr>
    <td><input value="${r.code||''}" data-k="code"></td>
    <td><input value="${r.name||''}" data-k="name"></td>
    <td><input type="number" value="${r.avg||''}" data-k="avg" step="1"></td>
    <td><input type="number" value="${r.qty||''}" data-k="qty" step="1"></td>
    <td><input class="readonly" value="${fmt(inv)}" readonly></td>
    <td><span class="dot ${upDot?'up':''}"></span><input type="number" value="${r.utarget||''}" data-k="utarget" step="${step}"></td>
    <td><span class="dot ${dnDot?'down':''}"></span><input type="number" value="${r.ltarget||''}" data-k="ltarget" step="${step}"></td>
    <td><input type="number" class="cur" value="${r.cur||''}" data-k="cur" step="1">${deltasHTML(r.code,cur)}</td>
    <td><input type="number" class="fix" value="${r.fix||''}" data-k="fix" step="1"></td>
    <td style="color:${profit>=0?ok():bad()}">${fmt(profit)}</td>
    <td style="color:${ratio>=0?ok():bad()}"><span class="pp">${(avg>0?ratio.toFixed(2):'0.00')}%</span></td>
    <td>
      <span class="actions">
        <button class="chart">차트</button>
        <span class="mv">
          <button class="up">▲</button>
          <button class="up10">▲10</button>
          <button class="down10">▼10</button>
          <button class="down">▼</button>
        </span>
        <button class="del">삭제</button>
      </span>
    </td>
  </tr>`;
}

function render(){
  $('#tbody').innerHTML = rows.map(rowHTML).join('');
  $$('#tbody tr').forEach((tr,i)=>{
    tr.querySelectorAll('input[data-k]').forEach(inp=>{
      inp.oninput=()=>{
        const k=inp.dataset.k, v=(inp.type==='number')?num(inp.value):inp.value;
        rows[i][k]=v; save(LS, rows);
        if(k==='cur'){ const step=(num(rows[i].cur)>100000)?500:100;
          const ut=tr.querySelector('input[data-k="utarget"]'); const lt=tr.querySelector('input[data-k="ltarget"]');
          if(ut) ut.step=step; if(lt) lt.step=step;
        }
        update();
      };
    });
    tr.querySelector('.del').onclick=()=>{ rows.splice(i,1); save(LS,rows); render(); };
    const up=tr.querySelector('.up'), down=tr.querySelector('.down'), up10=tr.querySelector('.up10'), down10=tr.querySelector('.down10');
    if(up) up.onclick=()=>{ if(i>0){ [rows[i-1],rows[i]]=[rows[i],rows[i-1]]; save(LS,rows); render(); } };
    if(down) down.onclick=()=>{ if(i<rows.length-1){ [rows[i+1],rows[i]]=[rows[i],rows[i+1]]; save(LS,rows); render(); } };
    if(up10) up10.onclick=()=>{ const j=Math.max(0,i-10); if(j!==i){ const it=rows.splice(i,1)[0]; rows.splice(j,0,it); save(LS,rows); render(); } };
    if(down10) down10.onclick=()=>{ const j=Math.min(rows.length-1,i+10); if(j!==i){ const it=rows.splice(i,1)[0]; rows.splice(j,0,it); save(LS,rows); render(); } };
    const cb=tr.querySelector('.chart'); if(cb) cb.onclick=()=>{ const r=rows[i]||{}; showChart(r.code,r.name); };
  });
  update();
}

function update(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r=rows[i]||{};
    const avg=num(r.avg), qty=num(r.qty), cur=num(r.cur), fix=num(r.fix)||cur;
    const inv=Math.round(avg*qty);
    tr.children[4].querySelector('input').value = fmt(inv);
    const profit=Math.round((fix-avg)*qty); total+=profit;
    tr.children[9].style.color=profit>=0?ok():bad();
    tr.children[9].textContent=fmt(profit);
    const ratio=(avg>0)?((fix-avg)/avg*100):0;
    tr.children[10].style.color=ratio>=0?ok():bad();
    tr.querySelector('.pp').textContent=(avg>0?ratio.toFixed(2):'0.00')+'%';
    // 목표 도트
    const upDot=(r.utarget && cur>=num(r.utarget)), dnDot=(r.ltarget && cur<=num(r.ltarget));
    const upEl=tr.children[5].querySelector('.dot'); const dnEl=tr.children[6].querySelector('.dot');
    upEl.classList.toggle('up', !!upDot); dnEl.classList.toggle('down', !!dnDot);
    // 스냅샷 & Δ 배지 재그리기
    if($('#trackToggle').checked && r.code && cur){ addSnap(r.code, cur); }
    const curCell=tr.children[7], old=curCell.querySelector('.delta-badges'); if(old) old.remove();
    curCell.insertAdjacentHTML('beforeend', deltasHTML(r.code, cur));
  });
  const badge=$('#topTotal');
  badge.textContent='총 손익: '+fmt(total);
  badge.classList.remove('total-pos','total-neg'); badge.classList.add(total>=0?'total-pos':'total-neg');
}

$('#addBtn').onclick = ()=>{ rows.push({code:'',name:'',avg:0,qty:0,utarget:'',ltarget:'',cur:0,fix:''}); save(LS,rows); render(); };
$('#addBtnBottom').onclick = ()=> $('#addBtn').click();
$('#saveBtn').onclick = ()=>{ save(LS,rows); save(LS_SET,settings); $('#state').textContent='상태: 저장됨'; $('#state').classList.add('ok'); };
$('#copyBtn').onclick = ()=>{
  const header=['코드','이름','매수가','주수','투입금액','상목표','하목표','현재가','매도가','손익(원)','손익(%)'].join('\t');
  const lines=rows.map(r=>{
    const avg=num(r.avg), qty=num(r.qty), cur=num(r.cur), fix=num(r.fix)||cur;
    const inv=Math.round(avg*qty), pf=Math.round((fix-avg)*qty); const rr=(avg>0?((fix-avg)/avg*100).toFixed(2):'0.00')+'%';
    return [r.code||'',r.name||'',avg,qty,inv,r.utarget||'',r.ltarget||'',cur,r.fix||'',pf,rr].join('\t');
  });
  const txt=header+'\r\n'+lines.join('\r\n'); navigator.clipboard.writeText(txt);
};
$('#testBtn').onclick = ()=>{
  if(rows.length===0){
    rows=[
      {code:'000150',name:'두산',avg:100000,qty:2,utarget:101000,ltarget:99000,cur:99500,fix:''},
      {code:'005930',name:'삼성전자',avg:98100,qty:66,utarget:101000,ltarget:99000,cur:99600,fix:''}
    ]; save(LS,rows);
  } render();
};

/* ====== 클라우드 저장/불러오기 (Apps Script 웹앱 URL 입력) ====== */
const CLOUD_URL = ""; // https://script.google.com/macros/s/AKfycb.../exec
const CLOUD_ID  = "stock-dashboard-rows";
async function cloudSave(){
  if(!CLOUD_URL){ alert('CLOUD_URL이 비어있습니다.'); return; }
  try{
    const payload={id:CLOUD_ID,rows,settings,ts:Date.now()};
    const res=await fetch(CLOUD_URL+'?id='+encodeURIComponent(CLOUD_ID),{method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},body:JSON.stringify(payload)});
    if(!res.ok) throw new Error('HTTP '+res.status);
    alert('클라우드 저장 완료');
  }catch(e){ alert('실패: '+(e&&e.message?e.message:e)); }
}
async function cloudLoad(){
  if(!CLOUD_URL){ alert('CLOUD_URL이 비어있습니다.'); return; }
  try{
    const res=await fetch(CLOUD_URL+'?id='+encodeURIComponent(CLOUD_ID),{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    if(data.rows) rows=data.rows;
    if(data.settings) settings=Object.assign(settings,data.settings);
    save(LS,rows); save(LS_SET,settings); render();
  }catch(e){ alert('실패: '+(e&&e.message?e.message:e)); }
}
$('#cloudSaveBtn').onclick=cloudSave; $('#cloudLoadBtn').onclick=cloudLoad;

/* ====== 폴링 틱 (프록시 연동 없다면 계산만) ====== */
function tick(){ if(!$('#live').checked) return; update(); }
setInterval(tick, Math.max(1, num($('#pollSec').value))*1000);
$('#pollSec').oninput = ()=>{};

/* ====== 차트 ====== */
let chart=null;
function showChart(code,name){
  const modal=$('#chartModal'); if(!modal) return;
  $('#chartTitle').textContent=(name||'')+' ('+(code||'')+')';
  const data=hLoad(code);
  if(!data || !data.length){ alert('저장된 히스토리가 아직 없습니다.'); return; }
  const labels=data.map(d=>{const dt=new Date(d.t);return String(dt.getHours()).padStart(2,'0')+':'+String(dt.getMinutes()).padStart(2,'0');});
  const prices=data.map(d=>d.p);
  if(chart){ chart.destroy(); chart=null; }
  chart=new Chart($('#histChart').getContext('2d'),{type:'line',data:{labels,datasets:[{data:prices,fill:false,tension:0.2}]},
    options:{plugins:{legend:{display:false}},animation:false,scales:{x:{grid:{display:false}},y:{beginAtZero:false}}}});
  modal.classList.add('show');
}
document.addEventListener('click',(e)=>{ if(e.target.id==='chartClose') $('#chartModal').classList.remove('show'); if(e.target.id==='chartModal' && e.target.classList.contains('modal')) $('#chartModal').classList.remove('show'); });

window.addEventListener('load', render);
</script>
</body>
</html>
