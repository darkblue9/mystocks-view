<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 v3.4h (미니멀 · 12px · 버튼 가로정렬)</title>
<style>
body{font-family:sans-serif;margin:10px;font-size:12px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px}
th,td{border:1px solid #ccc;padding:2px;text-align:center}
input,select,button{font:inherit;font-size:12px}
td input{width:60%;text-align:right}
td input[readonly]{background:#f9f9f9}
.mv{display:inline-flex;gap:2px;vertical-align:middle}
.mv button{width:20px;height:20px;font-size:10px;padding:0;margin:0}
.del{margin-left:4px;height:22px;font-size:11px}
.status{font-size:10px}
.profit-pos{color:green}
.profit-neg{color:red}
</style>
</head>
<body>
<div>
  <label>프록시 <input id="apiBase" value="http://localhost:3000" style="width:120px"></label>
  <label>엔드포인트 <select id="apiMode"><option value="auto">자동</option><option value="multi">멀티</option><option value="single">단건</option></select></label>
  <label>코드파라미터<input id="codeParam" value="code" style="width:60px"></label>
  <label>가격키<input id="priceKey" value="price" style="width:60px"></label>
  <label>풀링(초)<input id="pollSec" type="number" value="10" min="2" style="width:40px"></label>
  <label><input type="checkbox" id="liveToggle" checked>실시간</label>
  <button id="addRowBtn">+추가</button>
  <button id="saveBtn">저장</button>
  <button id="testBtn">테스트</button>
  <span id="status" class="status">상태: 대기</span>
</div>
<table id="grid">
  <thead><tr>
    <th>코드</th><th>이름</th><th>평단가</th><th>주수</th><th>투입금액</th>
    <th>현재가</th><th>고정가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div>총 손익: <span id="totalProfit" class="profit-neg">0</span> (수수료 0.26%)</div>

<script>
const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));
const fmt=n=>(n??0).toLocaleString('ko-KR');const toNum=v=>Number(String(v||'').replace(/,/g,''))||0;
const FEE_BUY=0.00015,FEE_SELL=0.00015,TAX_SELL=0.00230;
function calc(avg,cur,fix,qty){const b=fix||cur;const buy=avg*qty,sell=b*qty;
const fee=buy*FEE_BUY+sell*(FEE_SELL+TAX_SELL);const p=sell-buy-fee;return{won:p,pct:p/buy*100};}
const KEY='rows_v34h_mini_12px',SET='set_v34h_mini_12px';
function load(k){try{return JSON.parse(localStorage.getItem(k))||[]}catch{return[]}};
function save(k,v){localStorage.setItem(k,JSON.stringify(v))};
let rows=load(KEY);let timer=null;
function render(){
 const tb=$('#tbody');tb.innerHTML='';
 rows.forEach((r,i)=>{
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class=code value="${r.code||''}"></td>
<td><input class=name value="${r.name||''}"></td>
<td><input class=avg value="${r.avg||''}"></td>
<td><input class=qty value="${r.qty||''}"></td>
<td><input class=inv readonly></td>
<td><input class=cur value="${r.cur||''}"></td>
<td><input class=fix value="${r.fix||''}"></td>
<td class=num><span class=pw>0</span></td>
<td class=num><span class=pp>0%</span></td>
<td><div class="mv"><button class=up>▲</button><button class=down>▼</button></div><button class="del">삭제</button></td>`;
  tb.appendChild(tr);
  tr.querySelector('.del').onclick=()=>{rows.splice(i,1);save(KEY,rows);render();};
  tr.querySelector('.up').onclick=()=>{if(i>0){[rows[i-1],rows[i]]=[rows[i],rows[i-1]];save(KEY,rows);render();}};
  tr.querySelector('.down').onclick=()=>{if(i<rows.length-1){[rows[i+1],rows[i]]=[rows[i],rows[i+1]];save(KEY,rows);render();}};
  $$('input',tr).forEach(inp=>inp.oninput=()=>apply(i,tr));
 });
 update();
}
function apply(i,tr){
 const r=rows[i]={code:tr.querySelector('.code').value.trim(),
 name:tr.querySelector('.name').value.trim(),
 avg:toNum(tr.querySelector('.avg').value),
 qty:toNum(tr.querySelector('.qty').value),
 cur:toNum(tr.querySelector('.cur').value),
 fix:toNum(tr.querySelector('.fix').value)};
 r.inv=r.avg*r.qty;save(KEY,rows);update();
}
function update(){
 let tot=0;$$('#tbody tr').forEach((tr,i)=>{
  const r=rows[i];r.inv=r.avg*r.qty;
  tr.querySelector('.inv').value=fmt(r.inv);
  const {won,pct}=calc(r.avg,r.cur,r.fix,r.qty);tot+=won;
  tr.querySelector('.pw').textContent=fmt(won);
  tr.querySelector('.pw').className=won>=0?'profit-pos':'profit-neg';
  tr.querySelector('.pp').textContent=pct.toFixed(2)+'%';
 });
 const t=$('#totalProfit');t.textContent=fmt(tot);
 t.className=tot>=0?'profit-pos':'profit-neg';
}
$('#addRowBtn').onclick=()=>{rows.push({});save(KEY,rows);render();};
$('#saveBtn').onclick=()=>{save(KEY,rows);alert('저장');};
if(!rows.length){rows=[
 {code:'000660.KS',name:'SK하이닉스',avg:586000,qty:4,cur:553000},
 {code:'009830',name:'한화솔루션',avg:33800,qty:80,cur:31400},
 {code:'000250',name:'삼천당제약',avg:241000,qty:5,cur:235500}
];save(KEY,rows);}
render();
</script>
</body></html>