<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>stock_dashboard2 (원본 기반 · 기능추가)</title>
<style>
body{font-family:sans-serif;margin:10px;font-size:12px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px}
th,td{border:1px solid #ccc;padding:2px;text-align:center;vertical-align:middle}
input,select,button{font:inherit;font-size:12px}
td input{width:55%;text-align:right}
td input[readonly]{background:#f9f9f9}
.status{font-size:11px}
.profit-pos{color:green}
.profit-neg{color:red}

/* 행 이동/삭제 */
.actions{display:inline-flex;align-items:center;gap:4px;white-space:nowrap;justify-content:center}
.mv{display:inline-flex;gap:2px}
.mv button,.del{width:18px;height:18px;font-size:10px;padding:0;margin:0}
.del{width:auto;padding:0 6px;height:20px;font-size:11px}

/* 목표가 도트 점멸 */
@keyframes pulseRed { 0%{box-shadow:0 0 0 0 rgba(255,0,0,.8);} 100%{box-shadow:0 0 0 6px rgba(255,0,0,0);} }
@keyframes pulseBlue{ 0%{box-shadow:0 0 0 0 rgba(0,100,255,.8);} 100%{box-shadow:0 0 0 6px rgba(0,100,255,0);} }
.dot{width:8px;height:8px;border-radius:50%;background:#bbb;display:inline-block;flex:0 0 8px}
.dot.red{background:#ff4d4d}
.dot.blue{background:#3d7bff}
.blink-red-dot { animation: pulseRed .9s infinite; }
.blink-blue-dot{ animation: pulseBlue .9s infinite; }

/* 목표가 셀 */
.target-cell{display:flex;align-items:center;gap:6px;justify-content:center}
.target-cell input[type="number"]{width:72px} /* 원본 대비 약 10% 축소 */

/* 스피너(증감버튼) 항상 표시 강제 (브라우저별) */
input[type="number"]{appearance:auto;-webkit-appearance:auto;-moz-appearance:number-input}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:inner-spin-button;opacity:1;height:auto}

/* 토스트 */
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#333;color:#fff;padding:8px 12px;border-radius:8px;opacity:.95;z-index:9999}

/* 손익(원)/손익(%) 열 폭만 원본 대비 약 15% 축소 */
col.c-pwon{width:6.8%}
col.c-pct{width:5.1%}

</style>
</head>
<body>
<div id="toolbar">
  <label>프록시 <input id="apiBase" value="http://localhost:3000" style="width:140px"></label>
  <label>엔드포인트 
    <select id="apiMode">
      <option value="auto" selected>자동</option>
      <option value="multi">멀티</option>
      <option value="single">단건</option>
    </select>
  </label>
  <label>코드파라미터 <input id="codeParam" value="code" style="width:70px"></label>
  <label>가격키(JSON) <input id="priceKey" value="price" style="width:90px"></label>
  <label>풀링(초) <input id="pollSec" type="number" value="10" min="2" style="width:48px"></label>
  <label><input type="checkbox" id="liveToggle" checked>실시간</label>
  <button id="addRowBtn">+추가</button>
  <button id="saveBtn">저장</button>
  <button id="copyTxtBtn">텍스트로 복사</button>
  <span id="status" class="status">상태: 대기</span>
</div>

<table id="grid">
  <colgroup>
    <col class="c-code">
    <col class="c-name">
    <col class="c-buy">
    <col class="c-qty">
    <col class="c-invest">
    <col class="c-utarget">
    <col class="c-ltarget">
    <col class="c-cur">
    <col class="c-sell">
    <col class="c-pwon">
    <col class="c-pct">
    <col class="c-act">
  </colgroup>
  <thead><tr>
    <th>코드</th><th>이름</th><th>매수가</th><th>주수</th><th>투입금액</th>
    <th>상목표</th><th>하목표</th><th>현재가</th><th>매도가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div>총 손익: <span id="totalProfit" class="profit-neg">0</span> (수수료 0.26%)</div>

<script>
/* ===== 유틸 ===== */
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt=(n)=>(n??0).toLocaleString('ko-KR');
const toNum=(v)=>{ if(v===''||v==null) return 0; if(typeof v==='number') return v; return Number(String(v).replace(/,/g,''))||0; };
const getByPath=(obj,path)=>{ if(!path) return undefined; const parts=String(path).split('.'); let cur=obj; for(const p of parts){ if(cur==null) return undefined; cur=cur[p]; } return cur; };

/* 수수료/세율 */
const FEE_BUY=0.00015, FEE_SELL=0.00015, TAX_SELL=0.00230;
function calcProfit(avg, cur, fix, qty){
  const base=(fix && !isNaN(fix) && fix!==0) ? fix : cur;
  if(!avg||!qty||!base) return {won:0,pct:0};
  const buyAmt=avg*qty, sellAmt=base*qty;
  const feeBuy=buyAmt*FEE_BUY, feeSell=sellAmt*(FEE_SELL+TAX_SELL);
  const profit=(sellAmt-buyAmt)-feeBuy-feeSell;
  return {won:profit, pct: profit/buyAmt*100};
}

/* 저장키 (원본 파일과 충돌 피하려 동일 prefix 유지 가정) */
const KEY_ROWS='rows_v34h_targetdot';
const KEY_SET ='set_v34h_targetdot';

/* 상태 */
let rows=[], settings={};

/* ===== 설정 로드/저장 ===== */
function loadJSON(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function saveJSON(k,o){ localStorage.setItem(k, JSON.stringify(o)); }
function loadAll(){
  rows=loadJSON(KEY_ROWS,[]);
  settings=Object.assign({
    apiBase:'http://localhost:3000', apiMode:'auto', codeParam:'code', priceKey:'price',
    multiTpl:'/api/prices?codes={codes}', singleTpl:'/api/price?{codeParam}={code}', pollSec:10
  }, loadJSON(KEY_SET,{}));
}
function saveSettings(){
  settings.apiBase=$('#apiBase').value.trim();
  settings.apiMode=$('#apiMode').value;
  settings.codeParam=$('#codeParam').value.trim();
  settings.priceKey=$('#priceKey').value.trim();
  settings.pollSec=Math.max(2, Number($('#pollSec').value)||10);
  saveJSON(KEY_SET,settings);
}
function saveRows(){ saveJSON(KEY_ROWS,rows); }

/* ===== 코드 보정 ===== */
function normalizeCode(code){
  let c=(code||'').trim().toUpperCase();
  if(!c) return c;
  if(/^\d{6}$/.test(c)) c += '.KS';
  return c;
}

/* ===== 동적 step ===== */
function adjustStepForRow(tr){
  const curVal=toNum(tr.querySelector('.cur')?.value);
  const step=curVal>=100000?500:100;
  tr.querySelectorAll('.utarget,.ltarget').forEach(inp=>{ if(inp) inp.step=step; });
}
function adjustAllSteps(){ $$('#tbody tr').forEach(adjustStepForRow); }

/* ===== 렌더 ===== */
function render(){
  const tb=$('#tbody'); tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td><input class="avg" value="${r.avg?fmt(r.avg):''}"></td>
      <td><input class="qty" value="${r.qty||''}"></td>
      <td><input class="inv" readonly></td>
      <td><div class="target-cell"><span class="dot ut-dot"></span>
        <input type="number" min="0" step="100" class="utarget" value="${r.utarget||''}" title="상한목표가">
      </div></td>
      <td><div class="target-cell"><span class="dot lt-dot"></span>
        <input type="number" min="0" step="100" class="ltarget" value="${r.ltarget||''}" title="하목표가">
      </div></td>
      <td><input class="cur" value="${r.cur?fmt(r.cur):''}"></td>
      <td><input class="fix" value="${r.fix?fmt(r.fix):''}" title="매도가"></td>
      <td><span class="pw">0</span></td>
      <td><span class="pp">0%</span></td>
      <td><span class="actions">
            <span class="mv"><button class="up">▲</button><button class="down">▼</button></span>
            <button class="del">삭제</button>
          </span></td>`;
    tb.appendChild(tr);

    // 이벤트
    const upd=()=>applyRow(i,tr);
    $$('.code,.name,.avg,.qty,.cur,.fix,.utarget,.ltarget',tr).forEach(inp=>{
      inp.addEventListener('input',upd);
      inp.addEventListener('blur',upd);
      inp.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); } });
    });
    tr.querySelector('.del').onclick=()=>{ rows.splice(i,1); saveRows(); render(); };
    tr.querySelector('.up').onclick =()=>{ if(i>0){ [rows[i-1],rows[i]]=[rows[i],rows[i-1]]; saveRows(); render(); } };
    tr.querySelector('.down').onclick=()=>{ if(i<rows.length-1){ [rows[i+1],rows[i]]=[rows[i],rows[i+1]]; saveRows(); render(); } };

    // 초기 step 설정
    adjustStepForRow(tr);
  });
  updateProfits();
}

/* ===== 적용 ===== */
function applyRow(i,tr,live){
  const r=rows[i]||(rows[i]={});
  const get=(sel)=>(tr.querySelector(sel)?.value||'').trim();
  r.code=get('.code'); r.name=get('.name');
  r.avg=toNum(get('.avg')); r.qty=toNum(get('.qty'));
  r.cur=toNum(get('.cur')); r.fix=toNum(get('.fix'));
  r.utarget=toNum(get('.utarget')); r.ltarget=toNum(get('.ltarget'));
  r.inv=(r.avg||0)*(r.qty||0);
  tr.querySelector('.inv').value=fmt(r.inv||0);
  if(!live){
    tr.querySelector('.avg').value=r.avg?fmt(r.avg):'';
    tr.querySelector('.cur').value=r.cur?fmt(r.cur):'';
    tr.querySelector('.fix').value=r.fix?fmt(r.fix):'';
  }
  adjustStepForRow(tr);
  saveRows();
  updateProfits();
}

/* ===== 손익 & 도트 ===== */
function updateProfits(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r=rows[i]||{};
    r.inv=(r.avg||0)*(r.qty||0);
    tr.querySelector('.inv').value=fmt(r.inv);
    const {won,pct}=calcProfit(r.avg,r.cur,r.fix,r.qty);
    total+=won;
    const pw=tr.querySelector('.pw'), pp=tr.querySelector('.pp');
    if(pw){ pw.textContent=fmt(Math.round(won)); pw.className='pw '+(won>=0?'profit-pos':'profit-neg'); }
    if(pp){ pp.textContent=(isFinite(pct)?pct.toFixed(2):'0.00')+'%'; }

    const utDot=tr.querySelector('.ut-dot'), ltDot=tr.querySelector('.lt-dot');
    const up=(r.utarget||0)>0 && (r.cur||0)>=r.utarget;
    const dn=(r.ltarget||0)>0 && (r.cur||0)<=r.larget;
    // 오타 대비
    const ltargetVal=(r.ltarget||0);
    const isDown=(ltargetVal>0 && (r.cur||0)<=ltargetVal);
    utDot.className='dot ut-dot'+(up?' red blink-red-dot':'');
    ltDot.className='dot lt-dot'+(isDown?' blue blink-blue-dot':'');
  });
  const t=$('#totalProfit'); if(t){ t.textContent=fmt(Math.round(total)); t.className=(total>=0?'profit-pos':'profit-neg'); }
  saveRows();
}

/* ===== 텍스트로 복사 ===== */
function showToast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t); setTimeout(()=>t.remove(),1600);
}
function exportToText(){
  const headers=['코드','이름','매수가','주수','투입금액','상목표','하목표','현재가','매도가','손익(원)','손익(%)'];
  const lines=[headers.join('\t')];
  rows.forEach(r=>{
    const {code='',name='',avg=0,qty=0,inv=0,utarget=0,ltarget=0,cur=0,fix=0}=r||{};
    const {won,pct}=calcProfit(avg,cur,fix,qty);
    lines.push([
      code,
      name,
      fmt(avg),
      qty,
      fmt(inv),
      utarget?fmt(utarget):'',
      ltarget?fmt(ltarget):'',
      cur?fmt(cur):'',
      fix?fmt(fix):'',
      fmt(Math.round(won)),
      (isFinite(pct)?pct.toFixed(2):'0.00')+'%'
    ].join('\t'));
  });
  const out = lines.join('\r\n');
  if(navigator.clipboard){
    navigator.clipboard.writeText(out).then(()=>showToast('복사 완료! 엑셀에 붙여넣기(Ctrl+V) 하세요.'),()=>fallbackCopy(out));
  }else{ fallbackCopy(out); }
}
function fallbackCopy(text){
  const ta=document.createElement('textarea');
  ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px';
  document.body.appendChild(ta); ta.focus(); ta.select();
  try{ document.execCommand('copy'); showToast('복사 완료! 엑셀에 붙여넣기(Ctrl+V) 하세요.'); }
  catch{ alert('복사 실패. 아래 텍스트를 수동 복사하세요:\n\n'+text); }
  finally{ ta.remove(); }
}

/* ===== 폴링(선택사항: 프록시 API에 맞춰 수정 가능) ===== */
/* 여기서는 UI만 유지, 실제 호출은 비활성화 or 사용자 트리거에서만 사용 */
function setStatus(text, ok){
  const s=$('#status'); if(s){ s.textContent='상태: '+text; s.style.color=ok?'green':'red'; }
}

/* ===== 초기 ===== */
function initRowsIfEmpty(){
  if(!rows.length){
    rows=[
      {code:'009830',name:'한화솔루션',avg:33800,qty:80,cur:30800,utarget:31400,ltarget:30000},
      {code:'000250',name:'삼천당제약',avg:241000,qty:5,cur:234000,utarget:234000,ltarget:220000},
      {code:'100090',name:'SK오션플랜트',avg:21950,qty:115,cur:20650,utarget:20550,ltarget:19800}
    ];
    saveRows();
  }
}
function bindTopbar(){
  const ids=['apiBase','apiMode','codeParam','priceKey','pollSec'];
  ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('change', saveSettings); } });
  const add=$('#addRowBtn'); if(add){ add.onclick=()=>{ rows.push({}); saveRows(); render(); }; }
  const save=$('#saveBtn'); if(save){ save.onclick=()=>{ saveSettings(); saveRows(); showToast('저장되었습니다.'); }; }
  const copy=$('#copyTxtBtn'); if(copy){ copy.onclick=exportToText; }
}

function loadAllAndStart(){
  try{ const s=JSON.parse(localStorage.getItem(KEY_SET)||'null'); if(s) settings=s; }catch{}
  settings=Object.assign({apiBase:'http://localhost:3000',apiMode:'auto',codeParam:'code',priceKey:'price',pollSec:10}, settings||{});
  [['apiBase','apiBase'],['apiMode','apiMode'],['codeParam','codeParam'],['priceKey','priceKey'],['pollSec','pollSec']].forEach(([id,key])=>{
    const el=document.getElementById(id); if(el) el.value=settings[key];
  });
}

loadAll();
loadAllAndStart();
bindTopbar();
initRowsIfEmpty();
render();
</script>
</body>
</html>
