<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 v3.4h (상/하 목표가 · 점멸 · 알럿없음)</title>
<style>
body{font-family:sans-serif;margin:10px;font-size:12px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px}
th,td{border:1px solid #ccc;padding:2px;text-align:center}
input,select,button{font:inherit;font-size:12px}
td input{width:55%;text-align:right}
td input[readonly]{background:#f9f9f9}
.status{font-size:11px}
.profit-pos{color:green}
.profit-neg{color:red}
.actions{display:inline-flex;align-items:center;gap:4px;white-space:nowrap;justify-content:center}
.mv{display:inline-flex;gap:2px}
.mv button,.del{width:18px;height:18px;font-size:10px;padding:0;margin:0}
.del{width:auto;padding:0 6px;height:20px;font-size:11px}
@keyframes blinkRed { 0%{background:#ffe5e5} 100%{background:#ffffff} }
@keyframes blinkBlue{ 0%{background:#e5f0ff} 100%{background:#ffffff} }
.blink-red { animation: blinkRed 0.8s step-end infinite; }
.blink-blue{ animation: blinkBlue 0.8s step-end infinite; }
.shrink input{width:38%}
.shrink span{display:inline-block;max-width:100%;overflow:hidden;text-overflow:ellipsis}
col.c-code{width:8.5%}col.c-name{width:12.5%}col.c-buy{width:9%}col.c-qty{width:5%}
col.c-invest{width:10.5%}col.c-utarget{width:8%}col.c-ltarget{width:8%}col.c-cur{width:9%}
col.c-sell{width:8.5%}col.c-pwon{width:8%}col.c-pct{width:6%}col.c-act{width:7%}
details{margin:6px 0}summary{cursor:pointer}
</style>
</head>
<body>
<div>
  <label>프록시 <input id="apiBase" value="http://localhost:3000" style="width:140px"></label>
  <label>엔드포인트 
    <select id="apiMode">
      <option value="auto" selected>자동</option>
      <option value="multi">멀티</option>
      <option value="single">단건</option>
    </select>
  </label>
  <label>코드파라미터 <input id="codeParam" value="code" style="width:70px"></label>
  <label>가격키(JSON) <input id="priceKey" value="price" style="width:90px"></label>
  <label>풀링(초) <input id="pollSec" type="number" value="10" min="2" style="width:48px"></label>
  <label><input type="checkbox" id="liveToggle" checked>실시간</label>
  <button id="addRowBtn">+추가</button>
  <button id="saveBtn">저장</button>
  <button id="testBtn">테스트</button>
  <span id="status" class="status">상태: 대기</span>
</div>
<details>
  <summary>엔드포인트 템플릿 (필요시 수정) — {code}, {codes}, {codeParam} 치환</summary>
  <div>
    <label>멀티 <input id="multiTpl" value="/api/prices?codes={codes}" style="width:320px"></label>
    <label>단건 <input id="singleTpl" value="/api/price?{codeParam}={code}" style="width:320px"></label>
  </div>
</details>
<table id="grid">
  <colgroup>
    <col class="c-code"><col class="c-name"><col class="c-buy"><col class="c-qty">
    <col class="c-invest"><col class="c-utarget"><col class="c-ltarget"><col class="c-cur">
    <col class="c-sell"><col class="c-pwon"><col class="c-pct"><col class="c-act">
  </colgroup>
  <thead><tr>
    <th>코드</th><th>이름</th><th>매수가</th><th>주수</th><th>투입금액</th>
    <th>상목표</th><th>하목표</th><th>현재가</th><th>매도가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div>총 손익: <span id="totalProfit" class="profit-neg">0</span> (수수료 0.26%)</div>
<script>
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt=n=>(n??0).toLocaleString('ko-KR');
const toNum=v=>{ if(v===''||v==null) return 0; if(typeof v==='number') return v; return Number(String(v).replace(/,/g,''))||0; };
const getByPath=(obj,path)=>{ if(!path) return undefined; const parts=String(path).split('.'); let cur=obj; for(const p of parts){ if(cur==null) return undefined; cur=cur[p]; } return cur; };
const FEE_BUY=0.00015, FEE_SELL=0.00015, TAX_SELL=0.00230;
function calcProfit(avg,cur,fix,qty){
  const base=(fix && !isNaN(fix) && fix!==0)?fix:cur;
  if(!avg||!qty||!base) return {won:0,pct:0};
  const buyAmt=avg*qty, sellAmt=base*qty;
  const feeBuy=buyAmt*FEE_BUY, feeSell=sellAmt*(FEE_SELL+TAX_SELL);
  const profit=(sellAmt-buyAmt)-feeBuy-feeSell, pct=profit/buyAmt*100;
  return {won:profit, pct};
}
const KEY_ROWS='rows_v34h_min_dualtarget';
const KEY_SET='set_v34h_min_dualtarget';
let rows=[], settings={}, timer=null;
function loadJSON(k,d){ try{return JSON.parse(localStorage.getItem(k))??d}catch{return d} }
function saveJSON(k,o){ localStorage.setItem(k,JSON.stringify(o)) }
function loadAll(){
  rows=loadJSON(KEY_ROWS,[]);
  settings=Object.assign({
    apiBase:'http://localhost:3000', apiMode:'auto', codeParam:'code', priceKey:'price',
    multiTpl:'/api/prices?codes={codes}', singleTpl:'/api/price?{codeParam}={code}', pollSec:10
  }, loadJSON(KEY_SET,{}));
}
function saveSettings(){
  settings.apiBase=$('#apiBase').value.trim();
  settings.apiMode=$('#apiMode').value;
  settings.codeParam=$('#codeParam').value.trim();
  settings.priceKey=$('#priceKey').value.trim();
  settings.multiTpl=$('#multiTpl').value.trim();
  settings.singleTpl=$('#singleTpl').value.trim();
  settings.pollSec=Math.max(2,Number($('#pollSec').value)||10);
  saveJSON(KEY_SET,settings);
}
function saveRows(){ saveJSON(KEY_ROWS,rows) }
function normalizeCode(code){ let c=(code||'').trim().toUpperCase(); if(!c) return c; if(/^\d{6}$/.test(c)) c+='.KS'; return c }
function render(){
  const tb=$('#tbody'); tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td><input class="avg" value="${r.avg?fmt(r.avg):''}"></td>
      <td class="shrink"><input class="qty" value="${r.qty||''}"></td>
      <td><input class="inv" readonly></td>
      <td><input class="utarget" value="${r.utarget?fmt(r.utarget):''}" title="상한목표가"></td>
      <td><input class="ltarget" value="${r.ltarget?fmt(r.ltarget):''}" title="하한목표가"></td>
      <td><input class="cur" value="${r.cur?fmt(r.cur):''}"></td>
      <td><input class="fix" value="${r.fix?fmt(r.fix):''}" title="매도가"></td>
      <td class="shrink"><span class="pw">0</span></td>
      <td class="shrink"><span class="pp">0%</span></td>
      <td><span class="actions">
        <span class="mv"><button class="up">▲</button><button class="down">▼</button></span>
        <button class="del">삭제</button>
      </span></td>`;
    tb.appendChild(tr);
    tr.querySelector('.del').onclick=()=>{ if(confirm('정말 삭제하시겠습니까?')){ rows.splice(i,1); saveRows(); render(); } };
    tr.querySelector('.up').onclick=()=>{ if(i>0){ [rows[i-1],rows[i]]=[rows[i],rows[i-1]]; saveRows(); render(); } };
    tr.querySelector('.down').onclick=()=>{ if(i<rows.length-1){ [rows[i+1],rows[i]]=[rows[i],rows[i+1]]; saveRows(); render(); } };
    $$('.code,.name,.avg,.qty,.cur,.fix,.utarget,.ltarget',tr).forEach(inp=>{
      inp.addEventListener('input', ()=>applyRow(i,tr,true));
      inp.addEventListener('blur', ()=>applyRow(i,tr,false));
      inp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); inp.blur(); } });
    });
  });
  updateProfits();
}
function applyRow(i,tr,live){
  const r=rows[i]||(rows[i]={});
  const get=sel=>(tr.querySelector(sel)?.value||'').trim();
  r.code=get('.code'); r.name=get('.name'); r.avg=toNum(get('.avg')); r.qty=toNum(get('.qty'));
  r.cur=toNum(get('.cur')); r.fix=toNum(get('.fix'));
  r.utarget=toNum(get('.utarget')); r.ltarget=toNum(get('.ltarget'));
  r.inv=(r.avg||0)*(r.qty||0);
  tr.querySelector('.inv').value=fmt(r.inv||0);
  if(!live){
    tr.querySelector('.avg').value=r.avg?fmt(r.avg):'';
    tr.querySelector('.cur').value=r.cur?fmt(r.cur):'';
    tr.querySelector('.fix').value=r.fix?fmt(r.fix):'';
    tr.querySelector('.utarget').value=r.utarget?fmt(r.utarget):'';
    tr.querySelector('.ltarget').value=r.ltarget?fmt(r.ltarget):'';
  }
  saveRows(); updateProfits();
}
function updateProfits(){
  let total=0;
  $$('#tbody tr').forEach((tr,i)=>{
    const r=rows[i]||{};
    r.inv=(r.avg||0)*(r.qty||0);
    const invEl=tr.querySelector('.inv'); if(invEl) invEl.value=fmt(r.inv);
    const {won,pct}=calcProfit(r.avg,r.cur,r.fix,r.qty);
    total+=won;
    const pw=tr.querySelector('.pw'), pp=tr.querySelector('.pp');
    if(pw){ pw.textContent=fmt(Math.round(won)); pw.className='pw '+(won>=0?'profit-pos':'profit-neg'); }
    if(pp){ pp.textContent=(isFinite(pct)?pct.toFixed(2):'0.00')+'%'; }
    // 점멸 처리
    const utEl=tr.querySelector('.utarget'), ltEl=tr.querySelector('.ltarget'), curEl=tr.querySelector('.cur');
    const ut=r.utarget||0, lt=r.ltarget||0, cur=r.cur||0;
    const up=ut>0 && cur>=ut, dn=lt>0 && cur<=lt;
    [utEl,ltEl,curEl].forEach(el=>{ if(el){ el.classList.remove('blink-red','blink-blue'); }});
    if(up){ if(utEl) utEl.classList.add('blink-red'); if(curEl) curEl.classList.add('blink-red'); }
    if(dn){ if(ltEl) ltEl.classList.add('blink-blue'); if(curEl) curEl.classList.add('blink-blue'); }
  });
  const t=$('#totalProfit'); if(t){ t.textContent=fmt(Math.round(total)); t.className=(total>=0?'profit-pos':'profit-neg'); }
  saveRows();
}
function buildUrlSingle(code){
  const base=($('#apiBase').value||'').trim().replace(/\/$/,'');
  const tpl=($('#singleTpl').value||'/api/price?{codeParam}={code}').trim();
  const codeParam=($('#codeParam').value||'code').trim();
  const path=tpl.replace('{code}',encodeURIComponent(code)).replace('{codeParam}',encodeURIComponent(codeParam));
  return base+path;
}
function buildUrlMulti(codes){
  const base=($('#apiBase').value||'').trim().replace(/\/$/,'');
  const tpl=($('#multiTpl').value||'/api/prices?codes={codes}').trim();
  const path=tpl.replace('{codes}',encodeURIComponent(codes.join(',')));
  return base+path;
}
async function fetchPricesAuto(codes){
  const mode=$('#apiMode').value;
  try{
    if(mode==='multi'){ await fetchPricesMulti(codes); }
    else if(mode==='single'){ await fetchPricesSingle(codes); }
    else{ await fetchPricesMulti(codes).catch(()=>fetchPricesSingle(codes)); }
    setStatus('OK',true);
  }catch(err){ console.warn(err); setStatus(err.message||'오류',false); }
}
async function fetchPricesMulti(codes){
  saveSettings();
  const url=buildUrlMulti(codes.map(normalizeCode));
  const res=await fetch(url,{cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const j=await res.json();
  const priceKey=($('#priceKey').value||'price').trim();
  const codeParam=($('#codeParam').value||'code').trim();
  const arr=Array.isArray(j)?j:(j.data||j.results||[]);
  arr.forEach(p=>{
    const code=String(p[codeParam]||p.code||p.symbol||p.ticker||'').toUpperCase();
    const price=Number(getByPath(p,priceKey))||Number(p.price)||Number(p.last)||0;
    rows.forEach(r=>{ if(normalizeCode(r.code)===code){ r.cur=price||r.cur||0; }});
  });
  saveRows();
  $$('#tbody tr').forEach((tr,i)=>{ const inp=tr.querySelector('.cur'); if(inp) inp.value=rows[i].cur?fmt(rows[i].cur):''; });
  updateProfits();
}
async function fetchPricesSingle(codes){
  saveSettings();
  const priceKey=($('#priceKey').value||'price').trim();
  const results=await Promise.allSettled(codes.map(async code=>{
    const url=buildUrlSingle(normalizeCode(code));
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const j=await res.json();
    const price=Number(getByPath(j,priceKey))||Number(j.price)||Number(j.last)||Number(j?.data?.price)||0;
    return {code:normalizeCode(code),price};
  }));
  results.forEach(r=>{
    if(r.status==='fulfilled'){
      const {code,price}=r.value;
      rows.forEach(row=>{ if(normalizeCode(row.code)===code){ row.cur=price||row.cur||0; }});
    }
  });
  saveRows();
  $$('#tbody tr').forEach((tr,i)=>{ const inp=tr.querySelector('.cur'); if(inp) inp.value=rows[i].cur?fmt(rows[i].cur):''; });
  updateProfits();
}
function tick(){ if(!$('#liveToggle').checked) return; const codes=rows.map(r=>r.code).filter(Boolean); if(!codes.length) return; fetchPricesAuto(codes); }
function startPolling(){ stopPolling(); if(!$('#liveToggle').checked) return; const sec=Math.max(2,Number($('#pollSec').value)||10); timer=setInterval(tick,sec*1000); tick(); }
function stopPolling(){ if(timer){ clearInterval(timer); timer=null; } }
function setStatus(text,ok){ const s=$('#status'); if(s){ s.textContent='상태: '+text; s.style.color=ok?'green':'red'; } }
function ensureTopbar(){ if(!document.getElementById('status')){ const d=document.createElement('div'); d.innerHTML='<span id="status" class="status">상태: 대기</span>'; document.body.insertBefore(d,document.body.firstChild); } }
function initRowsIfEmpty(){
  if(!rows.length){
    rows=[
      {code:'009830',name:'한화솔루션',avg:33800,qty:80,cur:30950,utarget:31400,ltarget:30000},
      {code:'000250',name:'삼천당제약',avg:241000,qty:5,cur:229500,utarget:234000,ltarget:220000},
      {code:'100090',name:'SK오션플랜트',avg:21950,qty:115,cur:20200,utarget:20550,ltarget:19800},
      {code:'000660.KS',name:'SK하이닉스',avg:586000,qty:4,cur:544000,utarget:551000,ltarget:530000}
    ]; saveRows();
  }
}
function bindTopbar(){
  ['apiBase','apiMode','codeParam','priceKey','multiTpl','singleTpl','pollSec'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('change', saveSettings); } });
  const lt=document.getElementById('liveToggle'); if(lt){ lt.onchange=()=>{ if(lt.checked) startPolling(); else stopPolling(); }; }
  const add=document.getElementById('addRowBtn'); if(add){ add.onclick=()=>{ rows.push({}); saveRows(); render(); }; }
  const save=document.getElementById('saveBtn'); if(save){ save.onclick=()=>{ saveSettings(); saveRows(); alert('저장되었습니다.'); }; }
  const test=document.getElementById('testBtn'); if(test){ test.onclick=()=>{ const c=rows.map(r=>r.code).filter(Boolean); if(!c.length){alert('코드를 먼저 입력하세요');return;} fetchPricesAuto([c[0]]); }; }
}
function loadAllAndStart(){
  try{ const s=JSON.parse(localStorage.getItem(KEY_SET)||'null'); if(s) settings=s; }catch{}
  settings=Object.assign({ apiBase:'http://localhost:3000', apiMode:'auto', codeParam:'code', priceKey:'price', multiTpl:'/api/prices?codes={codes}', singleTpl:'/api/price?{codeParam}={code}', pollSec:10 }, settings||{});
  [['apiBase','apiBase'],['apiMode','apiMode'],['codeParam','codeParam'],['priceKey','priceKey'],['multiTpl','multiTpl'],['singleTpl','singleTpl'],['pollSec','pollSec']].forEach(([id,key])=>{ const el=document.getElementById(id); if(el){ el.value=settings[key]; }});
}
loadAll(); loadAllAndStart(); bindTopbar(); ensureTopbar(); initRowsIfEmpty(); render(); startPolling();
</script>
</body>
</html>