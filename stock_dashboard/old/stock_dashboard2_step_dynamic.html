<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>주식 대시보드 v3.4h-step-dynamic (목표가 step 동적: 100/500)</title>
<style>
body{font-family:sans-serif;margin:10px;font-size:12px}
table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:12px}
th,td{border:1px solid #ccc;padding:2px;text-align:center;vertical-align:middle}
input,select,button{font:inherit;font-size:12px}
td input{width:55%;text-align:right}
td input[readonly]{background:#f9f9f9}
.status{font-size:11px}
.profit-pos{color:green}
.profit-neg{color:red}
.actions{display:inline-flex;align-items:center;gap:4px;white-space:nowrap;justify-content:center}
.mv{display:inline-flex;gap:2px}
.mv button,.del{width:18px;height:18px;font-size:10px;padding:0;margin:0}
.del{width:auto;padding:0 6px;height:20px;font-size:11px}
@keyframes pulseRed {0%{box-shadow:0 0 0 0 rgba(255,0,0,.8);}100%{box-shadow:0 0 0 6px rgba(255,0,0,0);}}
@keyframes pulseBlue{0%{box-shadow:0 0 0 0 rgba(0,100,255,.8);}100%{box-shadow:0 0 0 6px rgba(0,100,255,0);}}
.dot{width:8px;height:8px;border-radius:50%;background:#bbb;display:inline-block;flex:0 0 8px}
.dot.red{background:#ff4d4d}
.dot.blue{background:#3d7bff}
.blink-red-dot{animation:pulseRed .9s infinite;}
.blink-blue-dot{animation:pulseBlue .9s infinite;}
.target-cell{display:flex;align-items:center;gap:6px;justify-content:center}
.target-cell input[type="number"]{width:70px}
</style>
</head>
<body>
<div>
  <label>프록시 <input id="apiBase" value="http://localhost:3000" style="width:140px"></label>
  <label>엔드포인트 
    <select id="apiMode">
      <option value="auto" selected>자동</option>
      <option value="multi">멀티</option>
      <option value="single">단건</option>
    </select>
  </label>
  <label>코드파라미터 <input id="codeParam" value="code" style="width:70px"></label>
  <label>가격키(JSON) <input id="priceKey" value="price" style="width:90px"></label>
  <label>풀링(초) <input id="pollSec" type="number" value="10" min="2" style="width:48px"></label>
  <label><input type="checkbox" id="liveToggle" checked>실시간</label>
  <button id="addRowBtn">+추가</button>
  <button id="saveBtn">저장</button>
  <button id="testBtn">테스트</button>
  <span id="status" class="status">상태: 대기</span>
</div>

<table id="grid">
  <thead><tr>
    <th>코드</th><th>이름</th><th>매수가</th><th>주수</th><th>투입금액</th>
    <th>상목표</th><th>하목표</th><th>현재가</th><th>매도가</th><th>손익(원)</th><th>손익(%)</th><th>▲▼/삭제</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div>총 손익: <span id="totalProfit" class="profit-neg">0</span> (수수료 0.26%)</div>

<script>
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
const fmt=(n)=>(n??0).toLocaleString('ko-KR');
const toNum=(v)=>{if(v===''||v==null)return 0;if(typeof v==='number')return v;return Number(String(v).replace(/,/g,''))||0;};

const KEY_ROWS='rows_v34h_dynamic';
let rows=JSON.parse(localStorage.getItem(KEY_ROWS)||'[]');
function saveRows(){localStorage.setItem(KEY_ROWS,JSON.stringify(rows));}

function adjustStep(tr){
  const cur=toNum(tr.querySelector('.cur')?.value);
  const step=cur>=100000?500:100;
  tr.querySelectorAll('.utarget,.ltarget').forEach(inp=>inp.step=step);
}

function render(){
  const tb=$('#tbody');tb.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="code" value="${r.code||''}"></td>
      <td><input class="name" value="${r.name||''}"></td>
      <td><input class="avg" value="${r.avg?fmt(r.avg):''}"></td>
      <td><input class="qty" value="${r.qty||''}"></td>
      <td><input class="inv" readonly></td>
      <td><div class="target-cell"><span class="dot ut-dot"></span>
        <input type="number" class="utarget" value="${r.utarget||''}" step="100" min="0">
      </div></td>
      <td><div class="target-cell"><span class="dot lt-dot"></span>
        <input type="number" class="ltarget" value="${r.ltarget||''}" step="100" min="0">
      </div></td>
      <td><input class="cur" value="${r.cur?fmt(r.cur):''}"></td>
      <td><input class="fix" value="${r.fix?fmt(r.fix):''}"></td>
      <td><span class="pw">0</span></td>
      <td><span class="pp">0%</span></td>
      <td><button class="del">삭제</button></td>`;
    tb.appendChild(tr);

    const upd=()=>applyRow(i,tr);
    $$('.code,.name,.avg,.qty,.cur,.fix,.utarget,.ltarget',tr).forEach(inp=>{
      inp.addEventListener('input',upd);
      inp.addEventListener('blur',upd);
    });
    tr.querySelector('.del').onclick=()=>{rows.splice(i,1);saveRows();render();};
    adjustStep(tr);
  });
  updateDots();
}

function applyRow(i,tr){
  const r=rows[i]||(rows[i]={});
  const get=(sel)=>tr.querySelector(sel)?.value||'';
  r.code=get('.code');
  r.name=get('.name');
  r.avg=toNum(get('.avg'));
  r.qty=toNum(get('.qty'));
  r.cur=toNum(get('.cur'));
  r.fix=toNum(get('.fix'));
  r.utarget=toNum(get('.utarget'));
  r.ltarget=toNum(get('.ltarget'));
  r.inv=(r.avg||0)*(r.qty||0);
  tr.querySelector('.inv').value=fmt(r.inv||0);
  adjustStep(tr);
  saveRows();
  updateDots();
}

function updateDots(){
  $$('#tbody tr').forEach((tr,i)=>{
    const r=rows[i]||{};
    const utDot=$('.ut-dot',tr),ltDot=$('.lt-dot',tr);
    const up=r.utarget&&r.cur>=r.utarget;
    const dn=r.ltarget&&r.cur<=r.ltarget;
    utDot.className='dot ut-dot'+(up?' red blink-red-dot':'');
    ltDot.className='dot lt-dot'+(dn?' blue blink-blue-dot':'');
  });
}

if(!rows.length){rows=[{code:'000660',name:'SK하이닉스',avg:580000,qty:4,cur:97800,utarget:99000,ltarget:95000}];saveRows();}
render();
</script>
</body>
</html>
